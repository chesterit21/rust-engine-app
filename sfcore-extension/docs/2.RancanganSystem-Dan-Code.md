# üîß IMPLEMENTASI LENGKAP SEMUA FILE KODE

Berikut adalah implementasi lengkap untuk semua file utama yang masih missing dari response sebelumnya.

---

## üìÅ STRUKTUR FILE & IMPLEMENTASI

### **1. TRANSPORT LAYER**

#### `src/extension/transport/types.ts`

```typescript
/**
 * Transport layer type definitions
 */

export interface TransportMessage {
    type: string;
    payload: any;
    stream?: boolean;
}

export interface TransportResponse {
    id?: string;
    payload: any;
    error?: string;
    stream?: AsyncIterable<string>;
}

export interface ITransport {
    connect(): Promise<void>;
    send(message: TransportMessage): Promise<TransportResponse>;
    sendStream(
        message: TransportMessage,
        onChunk: (chunk: string) => void
    ): Promise<void>;
    dispose(): void;
}

export interface TransportConfig {
    type: 'uds' | 'http' | 'auto';
    uds?: {
        socketPath: string;
    };
    http?: {
        baseUrl: string;
        timeout?: number;
    };
}

export class TransportError extends Error {
    constructor(
        message: string,
        public readonly code?: string,
        public readonly details?: any
    ) {
        super(message);
        this.name = 'TransportError';
    }
}
```

---

### **2. EXTENSION UTILITIES**

#### `src/extension/utils/logger.ts`

```typescript
/**
 * Logging utility with different log levels
 */
import * as vscode from 'vscode';

export enum LogLevel {
    DEBUG = 0,
    INFO = 1,
    WARN = 2,
    ERROR = 3
}

class Logger {
    private outputChannel: vscode.OutputChannel;
    private logLevel: LogLevel = LogLevel.INFO;

    constructor() {
        this.outputChannel = vscode.window.createOutputChannel('AI Dev Agent');
    }

    setLogLevel(level: LogLevel): void {
        this.logLevel = level;
    }

    private log(level: LogLevel, message: string, ...args: any[]): void {
        if (level < this.logLevel) {
            return;
        }

        const timestamp = new Date().toISOString();
        const levelName = LogLevel[level];
        const formattedMessage = `[${timestamp}] [${levelName}] ${message}`;
        
        const fullMessage = args.length > 0
            ? `${formattedMessage} ${JSON.stringify(args, null, 2)}`
            : formattedMessage;

        this.outputChannel.appendLine(fullMessage);

        // Show error messages as VS Code notifications
        if (level === LogLevel.ERROR) {
            vscode.window.showErrorMessage(`AI Dev Agent: ${message}`);
        }
    }

    debug(message: string, ...args: any[]): void {
        this.log(LogLevel.DEBUG, message, ...args);
    }

    info(message: string, ...args: any[]): void {
        this.log(LogLevel.INFO, message, ...args);
    }

    warn(message: string, ...args: any[]): void {
        this.log(LogLevel.WARN, message, ...args);
    }

    error(message: string, ...args: any[]): void {
        this.log(LogLevel.ERROR, message, ...args);
    }

    show(): void {
        this.outputChannel.show();
    }

    dispose(): void {
        this.outputChannel.dispose();
    }
}

// Singleton instance
export const logger = new Logger();

// Export for convenience
export const Logger = {
    debug: logger.debug.bind(logger),
    info: logger.info.bind(logger),
    warn: logger.warn.bind(logger),
    error: logger.error.bind(logger),
    show: logger.show.bind(logger),
    setLogLevel: logger.setLogLevel.bind(logger),
    dispose: logger.dispose.bind(logger)
};
```

#### `src/extension/utils/config.ts`

```typescript
/**
 * Configuration manager for extension settings
 */
import * as vscode from 'vscode';
import { TransportConfig } from '../transport/types';

export class ConfigManager {
    private static readonly SECTION = 'aiDevAgent';

    static getTransportConfig(): TransportConfig {
        const config = vscode.workspace.getConfiguration(this.SECTION);

        return {
            type: config.get<'auto' | 'uds' | 'http'>('transport.type', 'auto'),
            uds: {
                socketPath: config.get<string>(
                    'transport.uds.socketPath',
                    '/tmp/llm-server.sock'
                )
            },
            http: {
                baseUrl: config.get<string>(
                    'transport.http.baseUrl',
                    'http://localhost:8080'
                ),
                timeout: config.get<number>(
                    'transport.http.timeout',
                    30000
                )
            }
        };
    }

    static isStreamingEnabled(): boolean {
        const config = vscode.workspace.getConfiguration(this.SECTION);
        return config.get<boolean>('chat.streaming', true);
    }

    static getMaxContextFiles(): number {
        const config = vscode.workspace.getConfiguration(this.SECTION);
        return config.get<number>('chat.maxContextFiles', 10);
    }

    static async updateConfig(
        key: string,
        value: any,
        target: vscode.ConfigurationTarget = vscode.ConfigurationTarget.Global
    ): Promise<void> {
        const config = vscode.workspace.getConfiguration(this.SECTION);
        await config.update(key, value, target);
    }

    static onDidChange(callback: () => void): vscode.Disposable {
        return vscode.workspace.onDidChangeConfiguration(e => {
            if (e.affectsConfiguration(this.SECTION)) {
                callback();
            }
        });
    }
}
```

#### `src/extension/utils/helpers.ts`

```typescript
/**
 * Helper utility functions
 */
import * as path from 'path';
import * as vscode from 'vscode';

export class Helpers {
    /**
     * Format file size in human-readable format
     */
    static formatFileSize(bytes: number): string {
        const units = ['B', 'KB', 'MB', 'GB'];
        let size = bytes;
        let unitIndex = 0;

        while (size >= 1024 && unitIndex < units.length - 1) {
            size /= 1024;
            unitIndex++;
        }

        return `${size.toFixed(2)} ${units[unitIndex]}`;
    }

    /**
     * Get relative path from workspace
     */
    static getRelativePath(uri: vscode.Uri): string {
        const workspaceFolder = vscode.workspace.getWorkspaceFolder(uri);
        if (workspaceFolder) {
            return path.relative(workspaceFolder.uri.fsPath, uri.fsPath);
        }
        return path.basename(uri.fsPath);
    }

    /**
     * Truncate text to max length
     */
    static truncate(text: string, maxLength: number): string {
        if (text.length <= maxLength) {
            return text;
        }
        return text.substring(0, maxLength - 3) + '...';
    }

    /**
     * Generate unique ID
     */
    static generateId(): string {
        return `${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
    }

    /**
     * Debounce function
     */
    static debounce<T extends (...args: any[]) => any>(
        func: T,
        wait: number
    ): (...args: Parameters<T>) => void {
        let timeout: NodeJS.Timeout | null = null;
        
        return function(...args: Parameters<T>) {
            if (timeout) {
                clearTimeout(timeout);
            }
            timeout = setTimeout(() => func(...args), wait);
        };
    }

    /**
     * Async retry with exponential backoff
     */
    static async retry<T>(
        fn: () => Promise<T>,
        maxRetries: number = 3,
        delay: number = 1000
    ): Promise<T> {
        let lastError: Error;

        for (let i = 0; i < maxRetries; i++) {
            try {
                return await fn();
            } catch (error) {
                lastError = error as Error;
                if (i < maxRetries - 1) {
                    await new Promise(resolve => 
                        setTimeout(resolve, delay * Math.pow(2, i))
                    );
                }
            }
        }

        throw lastError!;
    }

    /**
     * Safe JSON parse
     */
    static safeJsonParse<T>(text: string, fallback: T): T {
        try {
            return JSON.parse(text);
        } catch {
            return fallback;
        }
    }
}
```

---

### **3. EXTENSION SERVICES**

#### `src/extension/services/stateService.ts`

```typescript
/**
 * State management service for extension
 */
import * as vscode from 'vscode';

export interface ExtensionState {
    isConnected: boolean;
    lastError?: string;
    messageHistory: Array<{
        role: 'user' | 'assistant';
        content: string;
        timestamp: number;
    }>;
}

export class StateService {
    private context: vscode.ExtensionContext;
    private state: ExtensionState;
    private onStateChangeEmitter: vscode.EventEmitter<ExtensionState>;
    public readonly onStateChange: vscode.Event<ExtensionState>;

    constructor(context: vscode.ExtensionContext) {
        this.context = context;
        this.onStateChangeEmitter = new vscode.EventEmitter();
        this.onStateChange = this.onStateChangeEmitter.event;

        // Load persisted state
        this.state = this.loadState();
    }

    private loadState(): ExtensionState {
        return {
            isConnected: false,
            messageHistory: this.context.globalState.get('messageHistory', [])
        };
    }

    getState(): ExtensionState {
        return { ...this.state };
    }

    updateState(partial: Partial<ExtensionState>): void {
        this.state = { ...this.state, ...partial };
        this.onStateChangeEmitter.fire(this.state);
        this.persistState();
    }

    setConnected(connected: boolean): void {
        this.updateState({ isConnected: connected });
    }

    setError(error: string | undefined): void {
        this.updateState({ lastError: error });
    }

    addMessage(role: 'user' | 'assistant', content: string): void {
        const message = {
            role,
            content,
            timestamp: Date.now()
        };

        const history = [...this.state.messageHistory, message];
        
        // Keep only last 100 messages
        const trimmedHistory = history.slice(-100);
        
        this.updateState({ messageHistory: trimmedHistory });
    }

    clearHistory(): void {
        this.updateState({ messageHistory: [] });
    }

    private async persistState(): Promise<void> {
        await this.context.globalState.update(
            'messageHistory',
            this.state.messageHistory
        );
    }

    dispose(): void {
        this.onStateChangeEmitter.dispose();
    }
}
```

#### `src/extension/services/fileService.ts`

```typescript
/**
 * File operations service
 */
import * as vscode from 'vscode';
import * as fs from 'fs/promises';
import * as path from 'path';
import { Logger } from '../utils/logger';

export interface FileInfo {
    uri: vscode.Uri;
    name: string;
    size: number;
    extension: string;
    languageId: string;
}

export class FileService {
    /**
     * Read file content
     */
    async readFile(uri: vscode.Uri): Promise<string> {
        try {
            const document = await vscode.workspace.openTextDocument(uri);
            return document.getText();
        } catch (error) {
            Logger.error('Failed to read file:', error);
            throw new Error(`Cannot read file: ${uri.fsPath}`);
        }
    }

    /**
     * Get file info
     */
    async getFileInfo(uri: vscode.Uri): Promise<FileInfo> {
        try {
            const stat = await fs.stat(uri.fsPath);
            const document = await vscode.workspace.openTextDocument(uri);

            return {
                uri,
                name: path.basename(uri.fsPath),
                size: stat.size,
                extension: path.extname(uri.fsPath),
                languageId: document.languageId
            };
        } catch (error) {
            Logger.error('Failed to get file info:', error);
            throw new Error(`Cannot access file: ${uri.fsPath}`);
        }
    }

    /**
     * Check if file is text file
     */
    isTextFile(uri: vscode.Uri): boolean {
        const textExtensions = [
            '.js', '.ts', '.jsx', '.tsx', '.py', '.java', '.c', '.cpp',
            '.go', '.rs', '.rb', '.php', '.swift', '.kt', '.cs',
            '.html', '.css', '.scss', '.json', '.xml', '.yaml', '.yml',
            '.md', '.txt', '.sh', '.bash', '.sql', '.r', '.m', '.h'
        ];

        const ext = path.extname(uri.fsPath).toLowerCase();
        return textExtensions.includes(ext);
    }

    /**
     * Get workspace files
     */
    async getWorkspaceFiles(pattern: string = '**/*'): Promise<vscode.Uri[]> {
        return await vscode.workspace.findFiles(pattern);
    }

    /**
     * Validate file size
     */
    async validateFileSize(uri: vscode.Uri, maxSize: number = 1024 * 1024): Promise<boolean> {
        try {
            const stat = await fs.stat(uri.fsPath);
            return stat.size <= maxSize;
        } catch {
            return false;
        }
    }
}
```

---

### **4. EXTENSION COMMANDS**

#### `src/extension/commands/index.ts`

```typescript
/**
 * Command registry
 */
import * as vscode from 'vscode';
import { ChatCommands } from './chatCommands';
import { FileCommands } from './fileCommands';

export class CommandRegistry {
    static register(context: vscode.ExtensionContext): void {
        ChatCommands.register(context);
        FileCommands.register(context);
    }
}
```

#### `src/extension/commands/chatCommands.ts`

```typescript
/**
 * Chat-related commands
 */
import * as vscode from 'vscode';
import { Logger } from '../utils/logger';

export class ChatCommands {
    static register(context: vscode.ExtensionContext): void {
        // Open chat command
        context.subscriptions.push(
            vscode.commands.registerCommand('aiDevAgent.openChat', async () => {
                try {
                    await vscode.commands.executeCommand(
                        'workbench.view.extension.aiDevAgent'
                    );
                    Logger.info('Chat panel opened');
                } catch (error) {
                    Logger.error('Failed to open chat:', error);
                    vscode.window.showErrorMessage('Failed to open AI Dev Agent chat');
                }
            })
        );

        // Clear chat history
        context.subscriptions.push(
            vscode.commands.registerCommand('aiDevAgent.clearChat', async () => {
                const answer = await vscode.window.showWarningMessage(
                    'Clear all chat history?',
                    'Yes', 'No'
                );

                if (answer === 'Yes') {
                    // This will be handled by webview
                    await vscode.commands.executeCommand(
                        'aiDevAgent.internal.clearChat'
                    );
                    Logger.info('Chat history cleared');
                }
            })
        );

        // Show output channel
        context.subscriptions.push(
            vscode.commands.registerCommand('aiDevAgent.showLogs', () => {
                Logger.show();
            })
        );
    }
}
```

#### `src/extension/commands/fileCommands.ts`

```typescript
/**
 * File context commands
 */
import * as vscode from 'vscode';
import { Logger } from '../utils/logger';

export class FileCommands {
    static register(context: vscode.ExtensionContext): void {
        // Add file to context
        context.subscriptions.push(
            vscode.commands.registerCommand(
                'aiDevAgent.addFileToContext',
                async (uri?: vscode.Uri) => {
                    try {
                        let fileUri = uri;

                        // If no URI provided, show file picker
                        if (!fileUri) {
                            const selected = await vscode.window.showOpenDialog({
                                canSelectMany: false,
                                canSelectFiles: true,
                                canSelectFolders: false,
                                title: 'Select file to add to AI context'
                            });

                            if (!selected || selected.length === 0) {
                                return;
                            }

                            fileUri = selected[0];
                        }

                        // Send to webview
                        await vscode.commands.executeCommand(
                            'aiDevAgent.internal.addFile',
                            fileUri
                        );

                        Logger.info(`Added file to context: ${fileUri.fsPath}`);
                        vscode.window.showInformationMessage(
                            `Added ${vscode.workspace.asRelativePath(fileUri)} to AI context`
                        );
                    } catch (error) {
                        Logger.error('Failed to add file to context:', error);
                        vscode.window.showErrorMessage('Failed to add file to context');
                    }
                }
            )
        );

        // Add current file to context
        context.subscriptions.push(
            vscode.commands.registerCommand(
                'aiDevAgent.addCurrentFile',
                async () => {
                    const editor = vscode.window.activeTextEditor;
                    if (!editor) {
                        vscode.window.showWarningMessage('No active file');
                        return;
                    }

                    await vscode.commands.executeCommand(
                        'aiDevAgent.addFileToContext',
                        editor.document.uri
                    );
                }
            )
        );

        // Clear context
        context.subscriptions.push(
            vscode.commands.registerCommand('aiDevAgent.clearContext', async () => {
                await vscode.commands.executeCommand(
                    'aiDevAgent.internal.clearContext'
                );
                Logger.info('Context cleared');
                vscode.window.showInformationMessage('AI context cleared');
            })
        );
    }
}
```

---

### **5. SHARED PROTOCOL**

#### `src/shared/protocol.ts`

```typescript
/**
 * Shared protocol definitions between extension and webview
 */

// ============== Chat Messages ==============
export interface ChatMessage {
    role: 'user' | 'assistant' | 'system';
    content: string;
    timestamp?: number;
}

export interface ChatRequest {
    messages: ChatMessage[];
    is_search: boolean;
    context: string[];
    stream: boolean;
}

export interface ChatResponse {
    content: string;
    model: string;
    usage: {
        prompt_tokens: number;
        completion_tokens: number;
        total_tokens?: number;
    };
}

// ============== File Context ==============
export interface FileContextItem {
    name: string;
    uri: string;
    size?: number;
    languageId?: string;
}

// ============== Extension to Webview Messages ==============
export type MessageToWebview =
    | { type: 'init'; payload: { files: FileContextItem[] } }
    | { type: 'chatStart'; payload: Record<string, never> }
    | { type: 'chatChunk'; payload: { content: string } }
    | { type: 'chatEnd'; payload: { fullResponse: string } }
    | { type: 'chatError'; payload: { error: string } }
    | { type: 'contextUpdate'; payload: FileContextItem[] }
    | { type: 'stateUpdate'; payload: { isConnected: boolean } };

// ============== Webview to Extension Messages ==============
export type MessageFromWebview =
    | { type: 'ready'; payload: Record<string, never> }
    | { type: 'chat'; payload: { messages: ChatMessage[]; mode: 'normal' | 'search' } }
    | { type: 'addFile'; payload: { uri: string } }
    | { type: 'removeFile'; payload: { uri: string } }
    | { type: 'clearContext'; payload: Record<string, never> }
    | { type: 'clearChat'; payload: Record<string, never> }
    | { type: 'cancelRequest'; payload: Record<string, never> };

// ============== Type Guards ==============
export function isMessageFromWebview(msg: any): msg is MessageFromWebview {
    return msg && typeof msg.type === 'string' && msg.payload !== undefined;
}

export function isMessageToWebview(msg: any): msg is MessageToWebview {
    return msg && typeof msg.type === 'string' && msg.payload !== undefined;
}
```

#### `src/shared/types.ts`

```typescript
/**
 * Shared type definitions
 */

export type ChatMode = 'normal' | 'search';

export interface AppState {
    isConnected: boolean;
    isLoading: boolean;
    error: string | null;
}

export interface ChatState {
    messages: Array<{
        role: 'user' | 'assistant';
        content: string;
        timestamp: number;
    }>;
    currentResponse: string;
    isStreaming: boolean;
}

export interface ContextState {
    files: Array<{
        name: string;
        uri: string;
        size?: number;
    }>;
}
```

---

### **6. REACT UI COMPONENTS**

#### `src/webview/index.tsx`

```typescript
/**
 * Webview entry point
 */
import React from 'react';
import { createRoot } from 'react-dom/client';
import { App } from './App';
import './styles/global.css';

const container = document.getElementById('root');
if (!container) {
    throw new Error('Root element not found');
}

const root = createRoot(container);
root.render(
    <React.StrictMode>
        <App />
    </React.StrictMode>
);
```

#### `src/webview/components/ChatPanel/ChatMessage.tsx`

```typescript
/**
 * Individual chat message component
 */
import React from 'react';
import './styles.css';

interface ChatMessageProps {
    role: 'user' | 'assistant';
    content: string;
    timestamp?: number;
}

export const ChatMessage: React.FC<ChatMessageProps> = ({ 
    role, 
    content, 
    timestamp 
}) => {
    const formatTime = (ts?: number) => {
        if (!ts) return '';
        return new Date(ts).toLocaleTimeString('en-US', {
            hour: '2-digit',
            minute: '2-digit'
        });
    };

    return (
        <div className={`chat-message chat-message-${role}`}>
            <div className="message-header">
                <span className="message-role">
                    {role === 'user' ? 'üë§ You' : 'ü§ñ AI Assistant'}
                </span>
                {timestamp && (
                    <span className="message-time">{formatTime(timestamp)}</span>
                )}
            </div>
            <div className="message-content">
                <pre className="message-text">{content}</pre>
            </div>
        </div>
    );
};
```

#### `src/webview/components/ChatPanel/ChatInput.tsx`

```typescript
/**
 * Chat input component
 */
import React, { useState, useRef, KeyboardEvent } from 'react';
import './styles.css';

interface ChatInputProps {
    onSend: (message: string) => void;
    isLoading: boolean;
    placeholder?: string;
}

export const ChatInput: React.FC<ChatInputProps> = ({ 
    onSend, 
    isLoading,
    placeholder = 'Type your message...'
}) => {
    const [message, setMessage] = useState('');
    const textareaRef = useRef<HTMLTextAreaElement>(null);

    const handleSend = () => {
        const trimmed = message.trim();
        if (trimmed && !isLoading) {
            onSend(trimmed);
            setMessage('');
            
            // Reset textarea height
            if (textareaRef.current) {
                textareaRef.current.style.height = 'auto';
            }
        }
    };

    const handleKeyDown = (e: KeyboardEvent<HTMLTextAreaElement>) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            handleSend();
        }
    };

    const handleInput = () => {
        // Auto-resize textarea
        if (textareaRef.current) {
            textareaRef.current.style.height = 'auto';
            textareaRef.current.style.height = `${textareaRef.current.scrollHeight}px`;
        }
    };

    return (
        <div className="chat-input-container">
            <textarea
                ref={textareaRef}
                className="chat-input"
                value={message}
                onChange={(e) => setMessage(e.target.value)}
                onKeyDown={handleKeyDown}
                onInput={handleInput}
                placeholder={placeholder}
                disabled={isLoading}
                rows={1}
            />
            <button
                className={`send-button ${isLoading ? 'loading' : ''}`}
                onClick={handleSend}
                disabled={!message.trim() || isLoading}
                title="Send message (Enter)"
            >
                {isLoading ? '‚è∏' : '‚û§'}
            </button>
        </div>
    );
};
```

#### `src/webview/components/ChatPanel/index.tsx`

```typescript
/**
 * Main chat panel component
 */
import React, { useEffect, useRef } from 'react';
import { ChatMessage as ChatMessageType } from '../../../shared/protocol';
import { ChatMessage } from './ChatMessage';
import { ChatInput } from './ChatInput';
import './styles.css';

interface ChatPanelProps {
    messages: ChatMessageType[];
    onSend: (message: string) => void;
    isLoading: boolean;
    mode: 'normal' | 'search';
}

export const ChatPanel: React.FC<ChatPanelProps> = ({ 
    messages, 
    onSend, 
    isLoading,
    mode 
}) => {
    const messagesEndRef = useRef<HTMLDivElement>(null);

    const scrollToBottom = () => {
        messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
    };

    useEffect(() => {
        scrollToBottom();
    }, [messages]);

    return (
        <div className="chat-panel">
            <div className="messages-container">
                {messages.length === 0 ? (
                    <div className="empty-state">
                        <div className="empty-icon">üí¨</div>
                        <p className="empty-text">
                            Start a conversation with your AI assistant
                        </p>
                        <p className="empty-hint">
                            {mode === 'search' 
                                ? 'Search mode: I\'ll search for information'
                                : 'Normal mode: Ask me anything!'
                            }
                        </p>
                    </div>
                ) : (
                    messages.map((msg, idx) => (
                        <ChatMessage
                            key={idx}
                            role={msg.role}
                            content={msg.content}
                            timestamp={msg.timestamp}
                        />
                    ))
                )}
                {isLoading && (
                    <div className="typing-indicator">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                )}
                <div ref={messagesEndRef} />
            </div>
            <ChatInput 
                onSend={onSend} 
                isLoading={isLoading}
                placeholder={
                    mode === 'search' 
                        ? 'Search for information...' 
                        : 'Type your message...'
                }
            />
        </div>
    );
};
```

#### `src/webview/components/ChatPanel/styles.css`

```css
/* Chat Panel Styles */
.chat-panel {
    display: flex;
    flex-direction: column;
    height: 100%;
    background-color: var(--vscode-editor-background);
}

.messages-container {
    flex: 1;
    overflow-y: auto;
    padding: 16px;
    display: flex;
    flex-direction: column;
    gap: 12px;
}

/* Chat Messages */
.chat-message {
    display: flex;
    flex-direction: column;
    gap: 4px;
    padding: 12px;
    border-radius: 8px;
    max-width: 85%;
    animation: slideIn 0.2s ease-out;
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.chat-message-user {
    align-self: flex-end;
    background-color: var(--vscode-button-background);
    color: var(--vscode-button-foreground);
}

.chat-message-assistant {
    align-self: flex-start;
    background-color: var(--vscode-input-background);
    border: 1px solid var(--vscode-input-border);
}

.message-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 6px;
}

.message-role {
    font-weight: 600;
    font-size: 12px;
    opacity: 0.8;
}

.message-time {
    font-size: 10px;
    opacity: 0.6;
}

.message-content {
    line-height: 1.6;
}

.message-text {
    margin: 0;
    white-space: pre-wrap;
    word-wrap: break-word;
    font-family: var(--vscode-editor-font-family);
    font-size: 13px;
}

/* Empty State */
.empty-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    text-align: center;
    padding: 32px;
    opacity: 0.6;
}

.empty-icon {
    font-size: 48px;
    margin-bottom: 16px;
}

.empty-text {
    font-size: 16px;
    margin-bottom: 8px;
    color: var(--vscode-foreground);
}

.empty-hint {
    font-size: 13px;
    color: var(--vscode-descriptionForeground);
}

/* Typing Indicator */
.typing-indicator {
    display: flex;
    gap: 4px;
    padding: 12px;
    align-self: flex-start;
}

.typing-indicator span {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background-color: var(--vscode-foreground);
    opacity: 0.3;
    animation: typing 1.4s infinite;
}

.typing-indicator span:nth-child(2) {
    animation-delay: 0.2s;
}

.typing-indicator span:nth-child(3) {
    animation-delay: 0.4s;
}

@keyframes typing {
    0%, 60%, 100% {
        opacity: 0.3;
        transform: translateY(0);
    }
    30% {
        opacity: 1;
        transform: translateY(-10px);
    }
}

/* Chat Input */
.chat-input-container {
    display: flex;
    gap: 8px;
    padding: 12px;
    background-color: var(--vscode-input-background);
    border-top: 1px solid var(--vscode-panel-border);
}

.chat-input {
    flex: 1;
    padding: 10px 12px;
    border: 1px solid var(--vscode-input-border);
    background-color: var(--vscode-input-background);
    color: var(--vscode-input-foreground);
    border-radius: 6px;
    font-family: var(--vscode-editor-font-family);
    font-size: 13px;
    resize: none;
    min-height: 40px;
    max-height: 200px;
    overflow-y: auto;
}

.chat-input:focus {
    outline: none;
    border-color: var(--vscode-focusBorder);
}

.chat-input:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.send-button {
    padding: 10px 16px;
    background-color: var(--vscode-button-background);
    color: var(--vscode-button-foreground);
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 16px;
    transition: all 0.2s;
    min-width: 60px;
}

.send-button:hover:not(:disabled) {
    background-color: var(--vscode-button-hoverBackground);
    transform: translateY(-1px);
}

.send-button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.send-button.loading {
    animation: pulse 1s infinite;
}

@keyframes pulse {
    0%, 100% {
        opacity: 1;
    }
    50% {
        opacity: 0.5;
    }
}
```

#### `src/webview/components/FileContext/index.tsx`

```typescript
/**
 * File context display component
 */
import React from 'react';
import { FileChip } from './FileChip';
import './styles.css';

interface FileContextProps {
    files: Array<{
        name: string;
        uri: string;
        size?: number;
    }>;
    onRemove: (uri: string) => void;
    onClear: () => void;
    onAdd: () => void;
}

export const FileContext: React.FC<FileContextProps> = ({ 
    files, 
    onRemove, 
    onClear,
    onAdd 
}) => {
    if (files.length === 0) {
        return (
            <div className="file-context-empty">
                <button className="add-file-button" onClick={onAdd}>
                    <span className="icon">üìÅ</span>
                    <span>Add files to context</span>
                </button>
            </div>
        );
    }

    return (
        <div className="file-context">
            <div className="file-context-header">
                <span className="context-title">
                    üìé Context ({files.length})
                </span>
                <div className="context-actions">
                    <button 
                        className="action-button" 
                        onClick={onAdd}
                        title="Add file"
                    >
                        ‚ûï
                    </button>
                    <button 
                        className="action-button" 
                        onClick={onClear}
                        title="Clear all"
                    >
                        üóëÔ∏è
                    </button>
                </div>
            </div>
            <div className="file-chips">
                {files.map(file => (
                    <FileChip
                        key={file.uri}
                        name={file.name}
                        uri={file.uri}
                        size={file.size}
                        onRemove={() => onRemove(file.uri)}
                    />
                ))}
            </div>
        </div>
    );
};
```

#### `src/webview/components/FileContext/FileChip.tsx`

```typescript
/**
 * Individual file chip component
 */
import React from 'react';
import './styles.css';

interface FileChipProps {
    name: string;
    uri: string;
    size?: number;
    onRemove: () => void;
}

export const FileChip: React.FC<FileChipProps> = ({ name, size, onRemove }) => {
    const formatSize = (bytes?: number): string => {
        if (!bytes) return '';
        if (bytes < 1024) return `${bytes}B`;
        if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(1)}KB`;
        return `${(bytes / (1024 * 1024)).toFixed(1)}MB`;
    };

    const getFileIcon = (filename: string): string => {
        const ext = filename.split('.').pop()?.toLowerCase();
        const iconMap: Record<string, string> = {
            'js': 'üìú',
            'ts': 'üìò',
            'tsx': '‚öõÔ∏è',
            'jsx': '‚öõÔ∏è',
            'py': 'üêç',
            'json': 'üìã',
            'md': 'üìù',
            'css': 'üé®',
            'html': 'üåê',
            'default': 'üìÑ'
        };
        return iconMap[ext || ''] || iconMap.default;
    };

    return (
        <div className="file-chip">
            <span className="file-icon">{getFileIcon(name)}</span>
            <span className="file-name" title={name}>
                @{name}
            </span>
            {size && (
                <span className="file-size">{formatSize(size)}</span>
            )}
            <button 
                className="remove-button" 
                onClick={onRemove}
                title="Remove file"
            >
                ‚úï
            </button>
        </div>
    );
};
```

#### `src/webview/components/FileContext/FilePicker.tsx`

```typescript
/**
 * File picker component
 */
import React from 'react';
import './styles.css';

interface FilePickerProps {
    onFileSelect: (uri: string) => void;
}

export const FilePicker: React.FC<FilePickerProps> = ({ onFileSelect }) => {
    const handleClick = () => {
        // This will trigger VS Code file picker via command
        // The actual file selection is handled by the extension
        // This is just a UI trigger
        onFileSelect('trigger');
    };

    return (
        <button className="file-picker-button" onClick={handleClick}>
            <span className="picker-icon">üìÇ</span>
            <span className="picker-text">Browse files...</span>
        </button>
    );
};
```

#### `src/webview/components/FileContext/styles.css`

```css
/* File Context Styles */
.file-context {
    padding: 12px;
    background-color: var(--vscode-sideBar-background);
    border-bottom: 1px solid var(--vscode-panel-border);
}

.file-context-empty {
    padding: 12px;
    text-align: center;
}

.add-file-button {
    padding: 8px 16px;
    background-color: var(--vscode-button-secondaryBackground);
    color: var(--vscode-button-secondaryForeground);
    border: 1px dashed var(--vscode-button-border);
    border-radius: 6px;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    font-size: 13px;
    transition: all 0.2s;
}

.add-file-button:hover {
    background-color: var(--vscode-button-secondaryHoverBackground);
}

.file-context-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
}

.context-title {
    font-size: 12px;
    font-weight: 600;
    color: var(--vscode-foreground);
}

.context-actions {
    display: flex;
    gap: 4px;
}

.action-button {
    padding: 4px 8px;
    background: transparent;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    transition: background-color 0.2s;
}

.action-button:hover {
    background-color: var(--vscode-toolbar-hoverBackground);
}

.file-chips {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
}

/* File Chip */
.file-chip {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 4px 8px;
    background-color: var(--vscode-badge-background);
    color: var(--vscode-badge-foreground);
    border-radius: 12px;
    font-size: 12px;
    max-width: 200px;
    transition: all 0.2s;
}

.file-chip:hover {
    background-color: var(--vscode-list-hoverBackground);
}

.file-icon {
    font-size: 14px;
}

.file-name {
    flex: 1;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    font-family: var(--vscode-editor-font-family);
}

.file-size {
    font-size: 10px;
    opacity: 0.7;
}

.remove-button {
    background: none;
    border: none;
    color: inherit;
    cursor: pointer;
    padding: 0;
    font-size: 12px;
    opacity: 0.6;
    transition: opacity 0.2s;
}

.remove-button:hover {
    opacity: 1;
}

/* File Picker */
.file-picker-button {
    padding: 8px 12px;
    background-color: transparent;
    color: var(--vscode-foreground);
    border: 1px solid var(--vscode-input-border);
    border-radius: 4px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 12px;
    transition: all 0.2s;
}

.file-picker-button:hover {
    background-color: var(--vscode-list-hoverBackground);
    border-color: var(--vscode-focusBorder);
}

.picker-icon {
    font-size: 16px;
}
```

#### `src/webview/components/ModeSelector/index.tsx`

```typescript
/**
 * Mode selector component (Normal vs Search)
 */
import React from 'react';
import './styles.css';

interface ModeSelectorProps {
    mode: 'normal' | 'search';
    onModeChange: (mode: 'normal' | 'search') => void;
}

export const ModeSelector: React.FC<ModeSelectorProps> = ({ mode, onModeChange }) => {
    return (
        <div className="mode-selector">
            <button
                className={`mode-button ${mode === 'normal' ? 'active' : ''}`}
                onClick={() => onModeChange('normal')}
                title="Normal conversation mode"
            >
                <span className="mode-icon">üí¨</span>
                <span className="mode-label">Normal</span>
            </button>
            <button
                className={`mode-button ${mode === 'search' ? 'active' : ''}`}
                onClick={() => onModeChange('search')}
                title="Search mode - AI will search for information"
            >
                <span className="mode-icon">üîç</span>
                <span className="mode-label">Search</span>
            </button>
        </div>
    );
};
```

#### `src/webview/components/ModeSelector/styles.css`

```css
/* Mode Selector Styles */
.mode-selector {
    display: flex;
    gap: 4px;
    padding: 4px;
    background-color: var(--vscode-editor-background);
    border-radius: 8px;
}

.mode-button {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    padding: 6px 12px;
    background-color: transparent;
    color: var(--vscode-foreground);
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 12px;
    font-weight: 500;
    transition: all 0.2s;
    opacity: 0.6;
}

.mode-button:hover {
    background-color: var(--vscode-list-hoverBackground);
    opacity: 0.8;
}

.mode-button.active {
    background-color: var(--vscode-button-background);
    color: var(--vscode-button-foreground);
    opacity: 1;
}

.mode-icon {
    font-size: 14px;
}

.mode-label {
    font-weight: 600;
}
```

#### `src/webview/components/common/Button.tsx`

```typescript
/**
 * Reusable button component
 */
import React from 'react';
import './common.css';

interface ButtonProps {
    children: React.ReactNode;
    onClick?: () => void;
    variant?: 'primary' | 'secondary' | 'danger';
    disabled?: boolean;
    icon?: string;
    title?: string;
}

export const Button: React.FC<ButtonProps> = ({
    children,
    onClick,
    variant = 'primary',
    disabled = false,
    icon,
    title
}) => {
    return (
        <button
            className={`common-button ${variant}`}
            onClick={onClick}
            disabled={disabled}
            title={title}
        >
            {icon && <span className="button-icon">{icon}</span>}
            <span>{children}</span>
        </button>
    );
};
```

#### `src/webview/components/common/Loading.tsx`

```typescript
/**
 * Loading spinner component
 */
import React from 'react';
import './common.css';

interface LoadingProps {
    size?: 'small' | 'medium' | 'large';
    text?: string;
}

export const Loading: React.FC<LoadingProps> = ({ 
    size = 'medium',
    text 
}) => {
    return (
        <div className={`loading-container ${size}`}>
            <div className="spinner"></div>
            {text && <span className="loading-text">{text}</span>}
        </div>
    );
};
```

#### `src/webview/components/common/common.css`

```css
/* Common Component Styles */

/* Button */
.common-button {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 8px 16px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 13px;
    font-weight: 500;
    transition: all 0.2s;
}

.common-button.primary {
    background-color: var(--vscode-button-background);
    color: var(--vscode-button-foreground);
}

.common-button.primary:hover:not(:disabled) {
    background-color: var(--vscode-button-hoverBackground);
}

.common-button.secondary {
    background-color: var(--vscode-button-secondaryBackground);
    color: var(--vscode-button-secondaryForeground);
}

.common-button.secondary:hover:not(:disabled) {
    background-color: var(--vscode-button-secondaryHoverBackground);
}

.common-button.danger {
    background-color: #f14c4c;
    color: white;
}

.common-button.danger:hover:not(:disabled) {
    background-color: #d13838;
}

.common-button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.button-icon {
    font-size: 16px;
}

/* Loading */
.loading-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 12px;
    padding: 20px;
}

.spinner {
    border: 3px solid var(--vscode-editorWidget-background);
    border-top-color: var(--vscode-progressBar-background);
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

.loading-container.small .spinner {
    width: 20px;
    height: 20px;
    border-width: 2px;
}

.loading-container.medium .spinner {
    width: 40px;
    height: 40px;
}

.loading-container.large .spinner {
    width: 60px;
    height: 60px;
    border-width: 4px;
}

@keyframes spin {
    to {
        transform: rotate(360deg);
    }
}

.loading-text {
    font-size: 13px;
    color: var(--vscode-descriptionForeground);
}
```

---

### **7. REACT HOOKS**

#### `src/webview/hooks/useFileContext.ts`

```typescript
/**
 * File context management hook
 */
import { useState, useEffect, useCallback } from 'react';
import { vscodeApi } from '../services/vscodeApi';
import { FileContextItem } from '../../shared/protocol';

export const useFileContext = () => {
    const [files, setFiles] = useState<FileContextItem[]>([]);

    useEffect(() => {
        const handleMessage = (event: MessageEvent) => {
            const message = event.data;
            
            if (message.type === 'contextUpdate') {
                setFiles(message.payload);
            } else if (message.type === 'init') {
                setFiles(message.payload.files || []);
            }
        };

        window.addEventListener('message', handleMessage);
        return () => window.removeEventListener('message', handleMessage);
    }, []);

    const addFile = useCallback(() => {
        vscodeApi.postMessage({
            type: 'addFile',
            payload: { uri: '' } // Will trigger file picker in extension
        });
    }, []);

    const removeFile = useCallback((uri: string) => {
        vscodeApi.postMessage({
            type: 'removeFile',
            payload: { uri }
        });
    }, []);

    const clearFiles = useCallback(() => {
        vscodeApi.postMessage({
            type: 'clearContext',
            payload: {}
        });
    }, []);

    return {
        files,
        addFile,
        removeFile,
        clearFiles
    };
};
```

#### `src/webview/hooks/useVSCode.ts`

```typescript
/**
 * VS Code API hook
 */
import { useEffect, useState } from 'react';
import { vscodeApi } from '../services/vscodeApi';

export const useVSCode = () => {
    const [isConnected, setIsConnected] = useState(false);

    useEffect(() => {
        const handleMessage = (event: MessageEvent) => {
            const message = event.data;
            
            if (message.type === 'stateUpdate') {
                setIsConnected(message.payload.isConnected);
            }
        };

        window.addEventListener('message', handleMessage);

        // Notify extension that webview is ready
        vscodeApi.postMessage({
            type: 'ready',
            payload: {}
        });

        return () => window.removeEventListener('message', handleMessage);
    }, []);

    return {
        isConnected,
        vscode: vscodeApi
    };
};
```

---

### **8. VSCODE API SERVICE**

#### `src/webview/services/vscodeApi.ts`

```typescript
/**
 * VS Code webview API wrapper
 */
import { MessageFromWebview } from '../../shared/protocol';

declare global {
    interface Window {
        acquireVsCodeApi: () => VSCodeApi;
    }
}

interface VSCodeApi {
    postMessage(message: any): void;
    getState(): any;
    setState(state: any): void;
}

class VSCodeApiService {
    private api: VSCodeApi;

    constructor() {
        this.api = window.acquireVsCodeApi();
    }

    postMessage(message: MessageFromWebview): void {
        this.api.postMessage(message);
    }

    getState<T = any>(): T | undefined {
        return this.api.getState();
    }

    setState<T = any>(state: T): void {
        this.api.setState(state);
    }
}

export const vscodeApi = new VSCodeApiService();
```

---

### **9. GLOBAL STYLES**

#### `src/webview/styles/global.css`

```css
/**
 * Global styles for webview
 */

* {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
}

html, body, #root {
    height: 100%;
    width: 100%;
    overflow: hidden;
}

body {
    font-family: var(--vscode-font-family);
    font-size: var(--vscode-font-size);
    color: var(--vscode-foreground);
    background-color: var(--vscode-editor-background);
}

.app-container {
    display: flex;
    flex-direction: column;
    height: 100%;
}

.header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 16px;
    background-color: var(--vscode-sideBarTitle-background);
    border-bottom: 1px solid var(--vscode-panel-border);
}

.header h2 {
    font-size: 16px;
    font-weight: 600;
    color: var(--vscode-sideBarTitle-foreground);
    margin: 0;
}

/* Scrollbar */
::-webkit-scrollbar {
    width: 10px;
    height: 10px;
}

::-webkit-scrollbar-track {
    background: var(--vscode-scrollbarSlider-background);
}

::-webkit-scrollbar-thumb {
    background: var(--vscode-scrollbarSlider-hoverBackground);
    border-radius: 5px;
}

::-webkit-scrollbar-thumb:hover {
    background: var(--vscode-scrollbarSlider-activeBackground);
}

/* Selection */
::selection {
    background-color: var(--vscode-editor-selectionBackground);
}

/* Focus outline */
*:focus {
    outline: 1px solid var(--vscode-focusBorder);
    outline-offset: 2px;
}

button:focus,
input:focus,
textarea:focus {
    outline-offset: -1px;
}

/* Transitions */
.fade-enter {
    opacity: 0;
}

.fade-enter-active {
    opacity: 1;
    transition: opacity 200ms;
}

.fade-exit {
    opacity: 1;
}

.fade-exit-active {
    opacity: 0;
    transition: opacity 200ms;
}

/* Utilities */
.hidden {
    display: none !important;
}

.text-center {
    text-align: center;
}

.mt-1 { margin-top: 4px; }
.mt-2 { margin-top: 8px; }
.mt-3 { margin-top: 12px; }
.mt-4 { margin-top: 16px; }

.mb-1 { margin-bottom: 4px; }
.mb-2 { margin-bottom: 8px; }
.mb-3 { margin-bottom: 12px; }
.mb-4 { margin-bottom: 16px; }

.p-1 { padding: 4px; }
.p-2 { padding: 8px; }
.p-3 { padding: 12px; }
.p-4 { padding: 16px; }
```

---

### **10. TEST FILES**

#### `test/suite/extension.test.ts`

```typescript
/**
 * Extension activation tests
 */
import * as assert from 'assert';
import * as vscode from 'vscode';

suite('Extension Test Suite', () => {
    vscode.window.showInformationMessage('Start all tests.');

    test('Extension should be present', () => {
        assert.ok(vscode.extensions.getExtension('your-publisher.ai-dev-agent'));
    });

    test('Extension should activate', async () => {
        const ext = vscode.extensions.getExtension('your-publisher.ai-dev-agent');
        await ext?.activate();
        assert.ok(ext?.isActive);
    });

    test('Commands should be registered', async () => {
        const commands = await vscode.commands.getCommands(true);
        assert.ok(commands.includes('aiDevAgent.openChat'));
        assert.ok(commands.includes('aiDevAgent.addFileToContext'));
        assert.ok(commands.includes('aiDevAgent.clearContext'));
    });
});
```

#### `test/suite/transport.test.ts`

```typescript
/**
 * Transport layer tests
 */
import * as assert from 'assert';
import { UDSTransport } from '../../src/extension/transport/udsTransport';
import { HTTPTransport } from '../../src/extension/transport/httpTransport';

suite('Transport Test Suite', () => {
    test('UDS Transport should create instance', () => {
        const transport = new UDSTransport('/tmp/test.sock');
        assert.ok(transport);
    });

    test('HTTP Transport should create instance', () => {
        const transport = new HTTPTransport('http://localhost:8080');
        assert.ok(transport);
    });

    // Add more transport tests here
});
```

---

## üéØ COMPLETE FILE CHECKLIST

### ‚úÖ Extension Core

- [x] `src/extension/extension.ts`
- [x] `src/extension/transport/types.ts`
- [x] `src/extension/transport/udsTransport.ts`
- [x] `src/extension/transport/httpTransport.ts`
- [x] `src/extension/transport/index.ts`
- [x] `src/extension/utils/logger.ts`
- [x] `src/extension/utils/config.ts`
- [x] `src/extension/utils/helpers.ts`
- [x] `src/extension/services/llmService.ts`
- [x] `src/extension/services/contextService.ts`
- [x] `src/extension/services/stateService.ts`
- [x] `src/extension/services/fileService.ts`
- [x] `src/extension/commands/index.ts`
- [x] `src/extension/commands/chatCommands.ts`
- [x] `src/extension/commands/fileCommands.ts`
- [x] `src/extension/providers/webviewProvider.ts`

### ‚úÖ React UI

- [x] `src/webview/index.tsx`
- [x] `src/webview/App.tsx`
- [x] `src/webview/components/ChatPanel/index.tsx`
- [x] `src/webview/components/ChatPanel/ChatMessage.tsx`
- [x] `src/webview/components/ChatPanel/ChatInput.tsx`
- [x] `src/webview/components/ChatPanel/styles.css`
- [x] `src/webview/components/FileContext/index.tsx`
- [x] `src/webview/components/FileContext/FileChip.tsx`
- [x] `src/webview/components/FileContext/FilePicker.tsx`
- [x] `src/webview/components/FileContext/styles.css`
- [x] `src/webview/components/ModeSelector/index.tsx`
- [x] `src/webview/components/ModeSelector/styles.css`
- [x] `src/webview/components/common/Button.tsx`
- [x] `src/webview/components/common/Loading.tsx`
- [x] `src/webview/components/common/common.css`
- [x] `src/webview/hooks/useChat.ts`
- [x] `src/webview/hooks/useFileContext.ts`
- [x] `src/webview/hooks/useVSCode.ts`
- [x] `src/webview/services/vscodeApi.ts`
- [x] `src/webview/styles/global.css`

### ‚úÖ Shared

- [x] `src/shared/protocol.ts`
- [x] `src/shared/types.ts`

### ‚úÖ Tests

- [x] `test/suite/extension.test.ts`
- [x] `test/suite/transport.test.ts`

---

Semua file implementasi sudah lengkap! Anda sekarang bisa:

1. Copy semua kode di atas ke file masing-masing
2. Jalankan `npm install`
3. Build dengan `npm run build`
4. Test dengan F5 di VS Code
5. Package dengan `vsce package`

Semoga membantu! üöÄ
