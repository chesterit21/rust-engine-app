# SSO (Single Sign-On) Fullstack Rust - Architecture Design
## Phase 1: Application Layer & Project Structure

---

## 1. ARSITEKTUR SISTEM OVERVIEW

### 1.1 High-Level Architecture

```
┌─────────────────────────────────────────────────────────────┐
│                    CLIENT APPLICATIONS                       │
│  (React/Vue/Angular Apps, Mobile Apps, Desktop Apps)        │
└──────────────────┬──────────────────────────────────────────┘
                   │ OAuth 2.0 / JWT
                   ▼
┌─────────────────────────────────────────────────────────────┐
│                 SSO SERVER (Fullstack Rust)                  │
│                                                               │
│  ┌────────────────────────────────────────────────────┐     │
│  │           FRONTEND LAYER (Rust WASM)               │     │
│  │    Leptos/Yew/Dioxus - Server-Side Rendering      │     │
│  └────────────────────────────────────────────────────┘     │
│                         │                                     │
│  ┌────────────────────────────────────────────────────┐     │
│  │              API GATEWAY LAYER                     │     │
│  │    Axum Web Framework - HTTP/HTTPS Handler         │     │
│  └────────────────────────────────────────────────────┘     │
│                         │                                     │
│  ┌────────────────────────────────────────────────────┐     │
│  │           BUSINESS LOGIC LAYER                     │     │
│  │  - Authentication Service (OAuth 2.0, JWT)         │     │
│  │  - User Management (RBAC)                          │     │
│  │  - Tenant Management                               │     │
│  │  - External Provider Integration                   │     │
│  └────────────────────────────────────────────────────┘     │
│                         │                                     │
│  ┌────────────────────────────────────────────────────┐     │
│  │           DATA ACCESS LAYER                        │     │
│  │    SQLx - PostgreSQL Async Connection Pool         │     │
│  └────────────────────────────────────────────────────┘     │
│                         │                                     │
│  ┌────────────────────────────────────────────────────┐     │
│  │              CACHING LAYER                         │     │
│  │    Redis - Session, Token, Permission Cache        │     │
│  └────────────────────────────────────────────────────┘     │
└─────────────────────────┬───────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────┐
│                  INFRASTRUCTURE LAYER                        │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │  PostgreSQL  │  │    Redis     │  │   Docker     │      │
│  │   Database   │  │    Cache     │  │  Container   │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└─────────────────────────────────────────────────────────────┘
```

### 1.2 Architecture Pattern
- **Clean Architecture / Hexagonal Architecture**
- **Domain-Driven Design (DDD)**
- **CQRS (Command Query Responsibility Segregation)** untuk operasi kompleks
- **Event-Driven** untuk audit trail dan logging

---

## 2. STRUKTUR PROYEK - PRODUCTION GRADE

### 2.1 Monorepo Structure

```
sfcore-ai/
│
├── Cargo.toml                      # Workspace configuration
├── .env.example                    # Environment template
├── .dockerignore
├── docker-compose.yml              # Docker orchestration
├── Dockerfile
├── README.md
├── CONTRIBUTING.md
├── LICENSE
│
├── sfcore-client-app/              # Application layer
│   ├── sso-server/                 # Main SSO server application
│   │   ├── Cargo.toml
│   │   ├── src/
│   │   │   ├── main.rs
│   │   │   ├── config/             # Configuration management
│   │   │   ├── routes/             # HTTP routes definition
│   │   │   └── startup.rs          # Application initialization
│   │   └── tests/
│   │
│   └── sso-frontend/               # Frontend application (Leptos/Yew)
│       ├── Cargo.toml
│       ├── src/
│       │   ├── main.rs
│       │   ├── components/         # UI Components
│       │   ├── pages/              # Page components
│       │   ├── hooks/              # Custom hooks
│       │   └── utils/
│       ├── static/                 # Static assets
│       └── styles/                 # CSS/SCSS files
│
├── crates/                         # Shared libraries (domain logic)
│   │
│   ├── sso-core-app/                   # Core domain models & business logic
│   │   ├── Cargo.toml
│   │   ├── src/
│   │   │   ├── lib.rs
│   │   │   ├── domain/             # Domain entities
│   │   │   │   ├── mod.rs
│   │   │   │   ├── user.rs
│   │   │   │   ├── tenant.rs
│   │   │   │   ├── client_app.rs
│   │   │   │   ├── group.rs
│   │   │   │   └── menu.rs
│   │   │   ├── services/           # Business logic services
│   │   │   │   ├── mod.rs
│   │   │   │   ├── auth_service.rs
│   │   │   │   ├── user_service.rs
│   │   │   │   ├── tenant_service.rs
│   │   │   │   └── rbac_service.rs
│   │   │   ├── repositories/       # Repository traits (ports)
│   │   │   │   ├── mod.rs
│   │   │   │   ├── user_repository.rs
│   │   │   │   └── tenant_repository.rs
│   │   │   └── error.rs            # Domain errors
│   │   └── tests/
│   │
│   ├── sso-infrastructure/         # Infrastructure implementations
│   │   ├── Cargo.toml
│   │   ├── src/
│   │   │   ├── lib.rs
│   │   │   ├── database/           # Database adapters
│   │   │   │   ├── mod.rs
│   │   │   │   ├── postgres/
│   │   │   │   │   ├── mod.rs
│   │   │   │   │   ├── user_repo_impl.rs
│   │   │   │   │   ├── tenant_repo_impl.rs
│   │   │   │   │   └── migrations/
│   │   │   │   └── connection.rs
│   │   │   ├── cache/              # Cache implementations
│   │   │   │   ├── mod.rs
│   │   │   │   ├── redis_cache.rs
│   │   │   │   └── memory_cache.rs
│   │   │   ├── oauth/              # OAuth providers
│   │   │   │   ├── mod.rs
│   │   │   │   ├── google.rs
│   │   │   │   ├── facebook.rs
│   │   │   │   └── microsoft.rs
│   │   │   └── email/              # Email service
│   │   │       └── smtp.rs
│   │   └── tests/
│   │
│   ├── sso-api/                    # API layer (HTTP handlers)
│   │   ├── Cargo.toml
│   │   ├── src/
│   │   │   ├── lib.rs
│   │   │   ├── handlers/           # HTTP request handlers
│   │   │   │   ├── mod.rs
│   │   │   │   ├── auth.rs
│   │   │   │   ├── user.rs
│   │   │   │   ├── tenant.rs
│   │   │   │   └── oauth.rs
│   │   │   ├── middleware/         # Custom middleware
│   │   │   │   ├── mod.rs
│   │   │   │   ├── auth.rs
│   │   │   │   ├── cors.rs
│   │   │   │   ├── rate_limit.rs
│   │   │   │   └── logging.rs
│   │   │   ├── dto/                # Data Transfer Objects
│   │   │   │   ├── mod.rs
│   │   │   │   ├── auth_dto.rs
│   │   │   │   ├── user_dto.rs
│   │   │   │   └── response.rs
│   │   │   └── validators/         # Input validation
│   │   │       ├── mod.rs
│   │   │       └── user_validator.rs
│   │   └── tests/
│   │
│   ├── sso-security/               # Security utilities
│   │   ├── Cargo.toml
│   │   ├── src/
│   │   │   ├── lib.rs
│   │   │   ├── jwt.rs              # JWT token handling
│   │   │   ├── password.rs         # Password hashing (bcrypt)
│   │   │   ├── csrf.rs             # CSRF protection
│   │   │   ├── session.rs          # Session management
│   │   │   └── encryption.rs       # Data encryption
│   │   └── tests/
│   │
│   └── sso-shared/                 # Shared utilities
│       ├── Cargo.toml
│       ├── src/
│       │   ├── lib.rs
│       │   ├── types.rs            # Common types (GUID, DateTime)
│       │   ├── constants.rs        # Application constants
│       │   ├── utils.rs            # Helper functions
│       │   └── telemetry/          # Logging & tracing
│       │       ├── mod.rs
│       │       └── logger.rs
│       └── tests/
│
├── migrations/                     # Database migrations (SQLx)
│   ├── 20240101000000_initial_schema.sql
│   ├── 20240101000001_create_users.sql
│   └── ...
│
├── scripts/                        # Utility scripts
│   ├── setup.sh                    # Initial setup
│   ├── migrate.sh                  # Run migrations
│   └── seed.sh                     # Seed database
│
├── docs/                           # Documentation
│   ├── architecture/
│   │   ├── adr/                    # Architecture Decision Records
│   │   └── diagrams/
│   ├── api/                        # API documentation
│   └── deployment/
│
└── tests/                          # Integration tests
    ├── integration/
    └── e2e/
```

---

## 3. TECHNOLOGY STACK

### 3.1 Backend Core

| Component | Technology | Version | Justification |
|-----------|------------|---------|---------------|
| **Web Framework** | Axum | ^0.7 | Production-grade, type-safe, high performance, tokio-based |
| **Database ORM** | SQLx | ^0.7 | Compile-time checked queries, async, zero-cost abstractions |
| **Async Runtime** | Tokio | ^1.35 | Industry standard, mature, excellent performance |
| **Serialization** | Serde | ^1.0 | De-facto standard, zero-copy deserialization |
| **OAuth/JWT** | jsonwebtoken | ^9.2 | Secure JWT implementation |
| **OAuth Client** | oauth2 | ^4.4 | RFC-compliant OAuth 2.0 client |
| **Password Hashing** | argon2 / bcrypt | ^0.5 / ^0.15 | Secure password hashing (Argon2 recommended over bcrypt) |
| **Validation** | validator | ^0.18 | Declarative validation |
| **Caching** | redis | ^0.24 | Fast in-memory cache |
| **Config Management** | config | ^0.14 | Environment-based configuration |
| **Error Handling** | thiserror | ^1.0 | Ergonomic error types |
| **Logging** | tracing + tracing-subscriber | ^0.1 | Structured logging |

### 3.2 Frontend Stack

| Component | Technology | Justification |
|-----------|------------|---------------|
| **Framework** | Leptos | Modern Rust frontend, SSR, fine-grained reactivity |
| **Alternative** | Yew / Dioxus | Mature options with great ecosystem |
| **Styling** | TailwindCSS | Utility-first, highly customizable, production-ready |
| **Icons** | Iconify / Heroicons | Modern icon library |
| **State Management** | Leptos Context / Signals | Built-in reactive state management |

### 3.3 Infrastructure

| Component | Technology | Justification |
|-----------|------------|---------------|
| **Database** | PostgreSQL 16+ | ACID compliance, advanced features, production-proven |
| **Cache** | Redis 7+ | In-memory speed, persistence options |
| **Container** | Docker + Docker Compose | Consistent environments |
| **Reverse Proxy** | Nginx / Traefik | Production-grade load balancing, SSL termination |
| **Monitoring** | Prometheus + Grafana | Metrics collection and visualization |

---

## 4. KEY DEPENDENCIES (Cargo.toml)

### 4.1 Workspace Root Cargo.toml

```toml
[workspace]
members = [
    "apps/sso-server",
    "apps/sso-frontend",
    "crates/sso-core",
    "crates/sso-infrastructure",
    "crates/sso-api",
    "crates/sso-security",
    "crates/sso-shared"
]
resolver = "2"

[workspace.dependencies]
# Web Framework
axum = { version = "0.7", features = ["macros", "multipart"] }
tower = "0.4"
tower-http = { version = "0.5", features = ["cors", "compression-gzip", "trace"] }

# Async Runtime
tokio = { version = "1.35", features = ["full"] }
async-trait = "0.1"

# Database
sqlx = { version = "0.7", features = ["runtime-tokio-rustls", "postgres", "uuid", "chrono", "migrate", "macros"] }
sea-query = "0.30"

# Serialization
serde = { version = "1.0", features = ["derive"] }
serde_json = "1.0"

# Security
jsonwebtoken = "9.2"
oauth2 = "4.4"
argon2 = "0.5"
bcrypt = "0.15"
uuid = { version = "1.6", features = ["v4", "serde"] }

# Validation
validator = { version = "0.18", features = ["derive"] }

# Caching
redis = { version = "0.24", features = ["tokio-comp", "connection-manager"] }

# Configuration
config = "0.14"
dotenvy = "0.15"

# Error Handling
thiserror = "1.0"
anyhow = "1.0"

# Logging & Tracing
tracing = "0.1"
tracing-subscriber = { version = "0.3", features = ["env-filter"] }

# Date & Time
chrono = { version = "0.4", features = ["serde"] }

# HTTP Client
reqwest = { version = "0.11", features = ["json", "rustls-tls"] }

# Testing
mockall = "0.12"
```

---

## 5. DESIGN PATTERNS & BEST PRACTICES

### 5.1 Repository Pattern
Memisahkan logika bisnis dari akses data menggunakan trait-based repositories.

```rust
// sso-core/src/repositories/user_repository.rs
#[async_trait]
pub trait UserRepository: Send + Sync {
    async fn find_by_id(&self, id: &Uuid) -> Result<Option<User>>;
    async fn find_by_email(&self, email: &str) -> Result<Option<User>>;
    async fn create(&self, user: &User) -> Result<User>;
    async fn update(&self, user: &User) -> Result<User>;
    async fn delete(&self, id: &Uuid) -> Result<()>;
}
```

### 5.2 Service Layer Pattern
Business logic terenkapsulasi dalam services yang menggunakan repositories.

```rust
// sso-core/src/services/auth_service.rs
pub struct AuthService {
    user_repo: Arc<dyn UserRepository>,
    cache: Arc<dyn CacheService>,
    jwt_service: Arc<JwtService>,
}

impl AuthService {
    pub async fn authenticate(&self, credentials: LoginCredentials) -> Result<AuthToken> {
        // Business logic here
    }
}
```

### 5.3 Error Handling Strategy

```rust
// sso-core/src/error.rs
use thiserror::Error;

#[derive(Error, Debug)]
pub enum DomainError {
    #[error("User not found: {0}")]
    UserNotFound(String),
    
    #[error("Invalid credentials")]
    InvalidCredentials,
    
    #[error("Email already exists: {0}")]
    EmailAlreadyExists(String),
    
    #[error("Database error: {0}")]
    DatabaseError(#[from] sqlx::Error),
}
```

### 5.4 Dependency Injection
Menggunakan Arc untuk shared state dan trait objects untuk loose coupling.

```rust
// apps/sso-server/src/main.rs
pub struct AppState {
    pub user_service: Arc<UserService>,
    pub auth_service: Arc<AuthService>,
    pub db_pool: PgPool,
    pub redis_client: RedisClient,
}
```

---

## 6. SECURITY ARCHITECTURE

### 6.1 Authentication Flow

```
1. User Login Request
   ↓
2. Validate Credentials (bcrypt/argon2)
   ↓
3. Generate JWT Access Token (15 min expiry)
   ↓
4. Generate Refresh Token (7 days expiry)
   ↓
5. Store Session in Redis
   ↓
6. Return Tokens + Set HTTP-Only Cookie
```

### 6.2 OAuth 2.0 Flow

```
1. User clicks "Login with Google"
   ↓
2. Redirect to OAuth Provider (Google/FB/Microsoft)
   ↓
3. User Authenticates
   ↓
4. Provider redirects back with Authorization Code
   ↓
5. Exchange Code for Access Token
   ↓
6. Fetch User Profile from Provider
   ↓
7. Create/Update User in Database
   ↓
8. Generate Internal JWT Token
   ↓
9. Establish Session
```

### 6.3 Security Measures

- **Password Hashing**: Argon2id (recommended) atau Bcrypt dengan cost factor 12
- **JWT**: RS256 signing algorithm, short expiry (15 min)
- **Refresh Tokens**: Stored in database, rotated on use
- **CSRF Protection**: Double-submit cookie pattern
- **Rate Limiting**: Token bucket algorithm (100 req/min per IP)
- **Input Validation**: Strict validation on all inputs
- **SQL Injection**: Prevented by SQLx compile-time checking
- **XSS Protection**: Content Security Policy headers
- **HTTPS Only**: Strict transport security headers
- **Session Management**: Redis-backed with automatic expiry

---

## 7. CACHING STRATEGY

### 7.1 Cache Layers

```rust
// Cache hierarchy
L1: In-memory (App State) → Ultra-fast, small dataset
L2: Redis → Fast, distributed cache
L3: PostgreSQL → Source of truth
```

### 7.2 Cache Keys Pattern

```
user:session:{user_id}           → User session data
user:permissions:{user_id}       → RBAC permissions
token:access:{token_id}          → Access token metadata
token:refresh:{token_id}         → Refresh token
oauth:state:{state_id}           → OAuth state verification
rate_limit:{ip}:{endpoint}       → Rate limiting counters
```

### 7.3 Cache Invalidation

- **Time-based**: TTL for all cache entries
- **Event-based**: Invalidate on user/permission updates
- **Cache-aside pattern**: Check cache → Miss → Load from DB → Update cache

---

## 8. DATABASE DESIGN PRINCIPLES

### 8.1 Naming Conventions
- **Tables**: snake_case, plural (member_users, client_apps)
- **Columns**: snake_case (created_at, is_active)
- **Primary Keys**: `id` (UUID v4)
- **Foreign Keys**: `{table_name}_id` (client_app_id)
- **Indexes**: `idx_{table}_{columns}` (idx_users_email)

### 8.2 Audit Trail Fields (All Tables)
```sql
created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
created_by UUID,
modified_at TIMESTAMPTZ,
modified_by UUID,
removed_at TIMESTAMPTZ,
removed_by UUID,
approved_at TIMESTAMPTZ,
approved_by UUID
```

### 8.3 Soft Delete Pattern
Menggunakan `removed_at` untuk soft delete, bukan hard delete.

---

## 9. API DESIGN

### 9.1 RESTful API Structure

```
/api/v1/auth
  POST   /register              → User registration
  POST   /login                 → Email/password login
  POST   /logout                → Logout
  POST   /refresh               → Refresh access token
  GET    /me                    → Get current user
  
/api/v1/oauth
  GET    /{provider}/authorize  → Initiate OAuth flow
  GET    /{provider}/callback   → OAuth callback
  
/api/v1/users
  GET    /                      → List users (paginated)
  GET    /{id}                  → Get user by ID
  POST   /                      → Create user
  PUT    /{id}                  → Update user
  DELETE /{id}                  → Soft delete user
  
/api/v1/tenants
  GET    /                      → List tenants
  POST   /                      → Create tenant
  GET    /{id}                  → Get tenant
  PUT    /{id}                  → Update tenant
  
/api/v1/groups
  GET    /                      → List groups
  POST   /                      → Create group
  PUT    /{id}                  → Update group
  
/api/v1/permissions
  GET    /user/{user_id}        → Get user permissions
  POST   /grant                 → Grant permission
```

### 9.2 Response Format

```json
{
  "success": true,
  "data": { ... },
  "meta": {
    "page": 1,
    "per_page": 20,
    "total": 100
  },
  "timestamp": "2024-01-20T10:30:00Z"
}
```

### 9.3 Error Response Format

```json
{
  "success": false,
  "error": {
    "code": "INVALID_CREDENTIALS",
    "message": "Invalid email or password",
    "details": null
  },
  "timestamp": "2024-01-20T10:30:00Z"
}
```

---

## 10. DEPLOYMENT ARCHITECTURE

### 10.1 Docker Compose Structure

```yaml
services:
  sso-server:
    build: .
    ports:
      - "8080:8080"
    environment:
      - DATABASE_URL=postgres://...
      - REDIS_URL=redis://...
    depends_on:
      - postgres
      - redis
  
  postgres:
    image: postgres:16-alpine
    volumes:
      - postgres_data:/var/lib/postgresql/data
  
  redis:
    image: redis:7-alpine
    volumes:
      - redis_data:/data
  
  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
```

### 10.2 Production Deployment
- **Orchestration**: Kubernetes / Docker Swarm
- **Load Balancer**: Nginx / Traefik
- **SSL/TLS**: Let's Encrypt certificates
- **Monitoring**: Prometheus + Grafana + Loki
- **Secrets Management**: HashiCorp Vault / Kubernetes Secrets

---

## 11. TESTING STRATEGY

### 11.1 Test Pyramid

```
        E2E Tests (5%)
       ─────────────
      Integration Tests (15%)
     ───────────────────────
    Unit Tests (80%)
   ─────────────────────────────
```

### 11.2 Test Organization

```rust
// Unit tests
#[cfg(test)]
mod tests {
    use super::*;
    
    #[tokio::test]
    async fn test_user_creation() {
        // Arrange
        // Act
        // Assert
    }
}

// Integration tests (tests/ directory)
#[tokio::test]
async fn test_full_authentication_flow() {
    // Test with real database (testcontainers)
}
```

---

## 12. REFERENSI & BEST PRACTICES

### 12.1 Rust Web Development
- **Zero to Production in Rust** (Luca Palmieri)
  - https://www.zero2prod.com/
  - Best practices untuk production Rust web services
  
- **Axum Official Examples**
  - https://github.com/tokio-rs/axum/tree/main/examples
  - Production-grade patterns

### 12.2 Authentication & Security
- **OAuth 2.0 RFC 6749**
  - https://datatracker.ietf.org/doc/html/rfc6749
  - Official OAuth 2.0 specification
  
- **JWT Best Practices**
  - https://datatracker.ietf.org/doc/html/rfc8725
  - JWT security considerations

- **OWASP Authentication Cheat Sheet**
  - https://cheatsheetseries.owasp.org/cheatsheets/Authentication_Cheat_Sheet.html
  - Security best practices

### 12.3 Database Design
- **PostgreSQL Best Practices**
  - https://wiki.postgresql.org/wiki/Don%27t_Do_This
  - Common anti-patterns to avoid

### 12.4 Rust Patterns
- **Rust API Guidelines**
  - https://rust-lang.github.io/api-guidelines/
  - Idiomatic Rust design

- **Tokio Best Practices**
  - https://tokio.rs/tokio/tutorial
  - Async programming patterns

### 12.5 Architecture Patterns
- **Clean Architecture (Robert C. Martin)**
  - https://blog.cleancoder.com/uncle-bob/2012/08/13/the-clean-architecture.html
  
- **Domain-Driven Design**
  - https://github.com/ddd-crew/ddd-starter-modelling-process

---

## 13. PERFORMANCE TARGETS

### 13.1 Response Time
- **Login**: < 200ms (p95)
- **API Endpoints**: < 100ms (p95)
- **Database Queries**: < 50ms (p95)

### 13.2 Throughput
- **Authentication**: > 1000 req/sec
- **API Calls**: > 5000 req/sec

### 13.3 Scalability
- **Horizontal Scaling**: Stateless design enables horizontal scaling
- **Database**: Read replicas for read-heavy operations
- **Cache**: Redis cluster for distributed caching

---

## 14. MONITORING & OBSERVABILITY

### 14.1 Metrics
- Request rate, latency, error rate (RED metrics)
- Database connection pool utilization
- Cache hit/miss ratio
- JWT token generation/validation rate

### 14.2 Logging
- Structured JSON logging dengan tracing
- Log levels: ERROR, WARN, INFO, DEBUG, TRACE
- Correlation IDs untuk request tracking

### 14.3 Tracing
- Distributed tracing dengan OpenTelemetry
- Jaeger untuk visualisasi traces

---

## KESIMPULAN PHASE 1

Arsitektur ini dirancang dengan prinsip:
1. **Modular**: Setiap komponen independen dan reusable
2. **Scalable**: Horizontal scaling ready
3. **Secure**: Multi-layer security approach
4. **Maintainable**: Clean code, well-documented
5. **Performant**: Rust zero-cost abstractions + async I/O
6. **Production-Ready**: Battle-tested patterns dan best practices

Struktur ini mengikuti standar industri dan best practices dari:
- Zero to Production in Rust
- Clean Architecture
- Domain-Driven Design
- OAuth 2.0 / JWT Standards
- OWASP Security Guidelines

**Next Phase**: Database schema design & SQL generation (Phase 2)