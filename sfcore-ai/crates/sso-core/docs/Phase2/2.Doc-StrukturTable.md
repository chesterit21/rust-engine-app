# SSO Fullstack Rust - Database Schema Design
## Phase 2: Database Structure & SQL Scripts

---

## 1. DATABASE OVERVIEW

### 1.1 Database Information
- **DBMS**: PostgreSQL 16+
- **Encoding**: UTF8
- **Timezone**: UTC
- **Extensions**: uuid-ossp, pgcrypto

### 1.2 Schema Design Principles
- **Primary Keys**: UUID v4 (auto-generated)
- **Audit Fields**: All tables include created_at, created_by, modified_at, modified_by, removed_at, removed_by, approved_at, approved_by
- **Soft Delete**: Using removed_at timestamp (NULL = active)
- **Indexing**: Strategic indexes on foreign keys and frequently queried columns
- **Constraints**: Foreign key constraints with CASCADE/SET NULL strategies
- **Unique Constraints**: Email, display_name uniqueness enforced at database level

---

## 2. ENTITY RELATIONSHIP DIAGRAM (ERD)

```
┌─────────────────────┐
│   member_user       │
│  (Core User Table)  │
└──────┬──────────────┘
       │
       ├──────────────────────────────────┐
       │                                  │
       ▼                                  ▼
┌──────────────────┐            ┌────────────────────────┐
│ user_sessions    │            │ member_user_tenant_app │
│ (Active Sessions)│            │  (User-Tenant Link)    │
└──────────────────┘            └───────┬────────────────┘
                                        │
                                        ▼
                                ┌───────────────┐
                                │  tenant_app   │
                                │   (Tenants)   │
                                └───────┬───────┘
                                        │
                                        ▼
                          ┌─────────────────────────┐
                          │ tenant_transaction_app  │
                          │  (Tenant Transfers)     │
                          └─────────────────────────┘

┌──────────────────┐
│   client_app     │
│ (Applications)   │
└────┬─────────────┘
     │
     ├───────────────┬─────────────────┬──────────────────┐
     │               │                 │                  │
     ▼               ▼                 ▼                  ▼
┌─────────┐   ┌──────────────┐  ┌─────────────┐  ┌──────────────┐
│menu_app │   │  group_app   │  │user_group   │  │group_menu_app│
│ (Menus) │   │  (Groups)    │  │_app         │  │(Permissions) │
└─────────┘   └──────────────┘  │(User-Group) │  └──────────────┘
                                 └─────────────┘

┌──────────────────┐
│  oauth_tokens    │
│ (OAuth Tokens)   │
└──────────────────┘

┌──────────────────┐
│  refresh_tokens  │
│ (Refresh Tokens) │
└──────────────────┘

┌──────────────────┐
│ oauth_providers  │
│(External Logins) │
└──────────────────┘
```

---

## 3. TABLE STRUCTURES

### 3.1 Core Tables

#### Table: member_user
**Purpose**: Stores all user accounts (internal and external OAuth users)

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| id | UUID | PRIMARY KEY DEFAULT uuid_generate_v4() | Unique user identifier |
| display_name | VARCHAR(100) | NOT NULL UNIQUE | User's display name |
| email | VARCHAR(255) | NOT NULL UNIQUE | User's email (login identifier) |
| password | VARCHAR(255) | NULL | Bcrypt hashed password (NULL for OAuth-only users) |
| is_active | BOOLEAN | NOT NULL DEFAULT TRUE | Account active status |
| is_login | BOOLEAN | NOT NULL DEFAULT FALSE | Currently logged in flag |
| last_login | TIMESTAMPTZ | NULL | Last successful login timestamp |
| status_member | VARCHAR(50) | NOT NULL DEFAULT 'new_register' | Values: new_register, wait_validation, invitation, active |
| link_profile_image | TEXT | NULL | URL to profile image |
| email_verified | BOOLEAN | NOT NULL DEFAULT FALSE | Email verification status |
| phone_number | VARCHAR(20) | NULL | Optional phone number |
| created_at | TIMESTAMPTZ | NOT NULL DEFAULT NOW() | Record creation timestamp |
| created_by | UUID | NULL | User who created this record |
| modified_at | TIMESTAMPTZ | NULL | Last modification timestamp |
| modified_by | UUID | NULL | User who last modified |
| removed_at | TIMESTAMPTZ | NULL | Soft delete timestamp |
| removed_by | UUID | NULL | User who removed this record |
| approved_at | TIMESTAMPTZ | NULL | Approval timestamp |
| approved_by | UUID | NULL | User who approved |

**Indexes**:
- idx_member_user_email ON member_user(email) WHERE removed_at IS NULL
- idx_member_user_display_name ON member_user(display_name) WHERE removed_at IS NULL
- idx_member_user_status ON member_user(status_member) WHERE removed_at IS NULL

---

#### Table: client_app
**Purpose**: Registered client applications that use SSO

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| id | UUID | PRIMARY KEY DEFAULT uuid_generate_v4() | Unique client app identifier |
| name | VARCHAR(100) | NOT NULL | Application name |
| description | TEXT | NULL | Application description |
| unique_name | VARCHAR(100) | NOT NULL UNIQUE | Unique identifier (slug) |
| type_app | VARCHAR(50) | NOT NULL | Values: web, mobile, desktop, api, console |
| url_app | TEXT | NOT NULL | Application URL/endpoint |
| client_secret | VARCHAR(255) | NOT NULL | OAuth client secret (hashed) |
| redirect_uris | TEXT[] | NOT NULL | Allowed redirect URIs (array) |
| is_active | BOOLEAN | NOT NULL DEFAULT TRUE | Application active status |
| created_at | TIMESTAMPTZ | NOT NULL DEFAULT NOW() | |
| created_by | UUID | NULL | |
| modified_at | TIMESTAMPTZ | NULL | |
| modified_by | UUID | NULL | |
| removed_at | TIMESTAMPTZ | NULL | |
| removed_by | UUID | NULL | |
| approved_at | TIMESTAMPTZ | NULL | |
| approved_by | UUID | NULL | |

**Indexes**:
- idx_client_app_unique_name ON client_app(unique_name) WHERE removed_at IS NULL

---

#### Table: menu_app
**Purpose**: Application menu items for RBAC

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| id | UUID | PRIMARY KEY DEFAULT uuid_generate_v4() | |
| client_app_id | UUID | NOT NULL REFERENCES client_app(id) | |
| menu_name | VARCHAR(100) | NOT NULL | Menu display name |
| menu_url | VARCHAR(255) | NOT NULL | Menu route/URL |
| parent_menu_id | UUID | NULL REFERENCES menu_app(id) | Parent menu for hierarchy |
| menu_icon | VARCHAR(100) | NULL | Icon class/name |
| menu_level | INTEGER | NOT NULL DEFAULT 1 | Menu depth level (1=root) |
| menu_order | INTEGER | NOT NULL DEFAULT 0 | Display order |
| is_active | BOOLEAN | NOT NULL DEFAULT TRUE | |
| created_at | TIMESTAMPTZ | NOT NULL DEFAULT NOW() | |
| created_by | UUID | NULL | |
| modified_at | TIMESTAMPTZ | NULL | |
| modified_by | UUID | NULL | |
| removed_at | TIMESTAMPTZ | NULL | |
| removed_by | UUID | NULL | |
| approved_at | TIMESTAMPTZ | NULL | |
| approved_by | UUID | NULL | |

**Constraints**:
- UNIQUE(client_app_id, menu_name) WHERE removed_at IS NULL

**Indexes**:
- idx_menu_app_client ON menu_app(client_app_id) WHERE removed_at IS NULL
- idx_menu_app_parent ON menu_app(parent_menu_id) WHERE removed_at IS NULL

---

#### Table: group_app
**Purpose**: User groups/roles within client applications

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| id | UUID | PRIMARY KEY DEFAULT uuid_generate_v4() | |
| client_app_id | UUID | NOT NULL REFERENCES client_app(id) | |
| name | VARCHAR(100) | NOT NULL | Group name (e.g., "Admin", "User") |
| description | TEXT | NULL | Group description |
| is_active | BOOLEAN | NOT NULL DEFAULT TRUE | |
| created_at | TIMESTAMPTZ | NOT NULL DEFAULT NOW() | |
| created_by | UUID | NULL | |
| modified_at | TIMESTAMPTZ | NULL | |
| modified_by | UUID | NULL | |
| removed_at | TIMESTAMPTZ | NULL | |
| removed_by | UUID | NULL | |
| approved_at | TIMESTAMPTZ | NULL | |
| approved_by | UUID | NULL | |

**Constraints**:
- UNIQUE(client_app_id, name) WHERE removed_at IS NULL

**Indexes**:
- idx_group_app_client ON group_app(client_app_id) WHERE removed_at IS NULL

---

#### Table: group_menu_app
**Purpose**: Permission matrix (which groups can access which menus with what actions)

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| id | UUID | PRIMARY KEY DEFAULT uuid_generate_v4() | |
| client_app_id | UUID | NOT NULL REFERENCES client_app(id) | |
| group_app_id | UUID | NOT NULL REFERENCES group_app(id) | |
| menu_app_id | UUID | NOT NULL REFERENCES menu_app(id) | |
| is_view | BOOLEAN | NOT NULL DEFAULT FALSE | Can view |
| is_add | BOOLEAN | NOT NULL DEFAULT FALSE | Can create |
| is_edit | BOOLEAN | NOT NULL DEFAULT FALSE | Can update |
| is_delete | BOOLEAN | NOT NULL DEFAULT FALSE | Can delete |
| is_approve | BOOLEAN | NOT NULL DEFAULT FALSE | Can approve |
| is_download | BOOLEAN | NOT NULL DEFAULT FALSE | Can download |
| is_upload | BOOLEAN | NOT NULL DEFAULT FALSE | Can upload |
| is_print | BOOLEAN | NOT NULL DEFAULT FALSE | Can print |
| created_at | TIMESTAMPTZ | NOT NULL DEFAULT NOW() | |
| created_by | UUID | NULL | |
| modified_at | TIMESTAMPTZ | NULL | |
| modified_by | UUID | NULL | |
| removed_at | TIMESTAMPTZ | NULL | |
| removed_by | UUID | NULL | |
| approved_at | TIMESTAMPTZ | NULL | |
| approved_by | UUID | NULL | |

**Constraints**:
- UNIQUE(client_app_id, group_app_id, menu_app_id) WHERE removed_at IS NULL

**Indexes**:
- idx_group_menu_app_group ON group_menu_app(group_app_id) WHERE removed_at IS NULL
- idx_group_menu_app_menu ON group_menu_app(menu_app_id) WHERE removed_at IS NULL

---

#### Table: user_group_app
**Purpose**: Links users to groups (user can have multiple groups)

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| id | UUID | PRIMARY KEY DEFAULT uuid_generate_v4() | |
| client_app_id | UUID | NOT NULL REFERENCES client_app(id) | |
| member_user_id | UUID | NOT NULL REFERENCES member_user(id) | |
| group_app_id | UUID | NOT NULL REFERENCES group_app(id) | |
| is_active | BOOLEAN | NOT NULL DEFAULT TRUE | |
| created_at | TIMESTAMPTZ | NOT NULL DEFAULT NOW() | |
| created_by | UUID | NULL | |
| modified_at | TIMESTAMPTZ | NULL | |
| modified_by | UUID | NULL | |
| removed_at | TIMESTAMPTZ | NULL | |
| removed_by | UUID | NULL | |
| approved_at | TIMESTAMPTZ | NULL | |
| approved_by | UUID | NULL | |

**Constraints**:
- UNIQUE(client_app_id, member_user_id, group_app_id) WHERE removed_at IS NULL

**Indexes**:
- idx_user_group_app_user ON user_group_app(member_user_id) WHERE removed_at IS NULL
- idx_user_group_app_group ON user_group_app(group_app_id) WHERE removed_at IS NULL

---

#### Table: tenant_app
**Purpose**: Multi-tenancy support (organizations/workspaces)

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| id | UUID | PRIMARY KEY DEFAULT uuid_generate_v4() | |
| name | VARCHAR(100) | NOT NULL UNIQUE | Tenant name |
| description | TEXT | NULL | Tenant description |
| slug | VARCHAR(100) | NOT NULL UNIQUE | URL-friendly identifier |
| is_active | BOOLEAN | NOT NULL DEFAULT TRUE | |
| max_users | INTEGER | NOT NULL DEFAULT 10 | Maximum users allowed |
| subscription_plan | VARCHAR(50) | NOT NULL DEFAULT 'free' | Values: free, basic, premium, enterprise |
| subscription_expires_at | TIMESTAMPTZ | NULL | Subscription expiry |
| created_at | TIMESTAMPTZ | NOT NULL DEFAULT NOW() | |
| created_by | UUID | NULL | |
| modified_at | TIMESTAMPTZ | NULL | |
| modified_by | UUID | NULL | |
| removed_at | TIMESTAMPTZ | NULL | |
| removed_by | UUID | NULL | |
| approved_at | TIMESTAMPTZ | NULL | |
| approved_by | UUID | NULL | |

**Indexes**:
- idx_tenant_app_slug ON tenant_app(slug) WHERE removed_at IS NULL

---

#### Table: member_user_tenant_app
**Purpose**: Links users to tenants (supports multiple tenants per user and ownership levels)

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| id | UUID | PRIMARY KEY DEFAULT uuid_generate_v4() | |
| tenant_app_id | UUID | NOT NULL REFERENCES tenant_app(id) | |
| member_user_id | UUID | NOT NULL REFERENCES member_user(id) | |
| is_owner | BOOLEAN | NOT NULL DEFAULT FALSE | Is tenant owner |
| level_owner | INTEGER | NULL | Owner hierarchy (1=primary, 2=secondary, etc.) |
| role_in_tenant | VARCHAR(50) | NOT NULL DEFAULT 'member' | Values: owner, admin, member, guest |
| joined_at | TIMESTAMPTZ | NOT NULL DEFAULT NOW() | When user joined tenant |
| created_at | TIMESTAMPTZ | NOT NULL DEFAULT NOW() | |
| created_by | UUID | NULL | |
| modified_at | TIMESTAMPTZ | NULL | |
| modified_by | UUID | NULL | |
| removed_at | TIMESTAMPTZ | NULL | |
| removed_by | UUID | NULL | |
| approved_at | TIMESTAMPTZ | NULL | |
| approved_by | UUID | NULL | |

**Constraints**:
- UNIQUE(tenant_app_id, member_user_id) WHERE removed_at IS NULL
- UNIQUE(tenant_app_id, level_owner) WHERE removed_at IS NULL AND is_owner = TRUE
- CHECK: level_owner IS NULL OR (is_owner = TRUE AND level_owner > 0)

**Indexes**:
- idx_member_user_tenant_user ON member_user_tenant_app(member_user_id)
- idx_member_user_tenant_tenant ON member_user_tenant_app(tenant_app_id)

---

#### Table: tenant_transaction_app
**Purpose**: Tracks tenant ownership transfers/changes

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| id | UUID | PRIMARY KEY DEFAULT uuid_generate_v4() | |
| tenant_app_id | UUID | NOT NULL REFERENCES tenant_app(id) | |
| from_member_user_id | UUID | NOT NULL REFERENCES member_user(id) | Previous owner |
| to_member_user_id | UUID | NOT NULL REFERENCES member_user(id) | New owner |
| transaction_type | VARCHAR(50) | NOT NULL | Values: transfer, invitation, promotion, demotion |
| transaction_date | TIMESTAMPTZ | NOT NULL DEFAULT NOW() | When transfer occurred |
| notes | TEXT | NULL | Transfer notes/reason |
| created_at | TIMESTAMPTZ | NOT NULL DEFAULT NOW() | |
| created_by | UUID | NULL | |
| modified_at | TIMESTAMPTZ | NULL | |
| modified_by | UUID | NULL | |
| removed_at | TIMESTAMPTZ | NULL | |
| removed_by | UUID | NULL | |
| approved_at | TIMESTAMPTZ | NULL | |
| approved_by | UUID | NULL | |

**Indexes**:
- idx_tenant_transaction_tenant ON tenant_transaction_app(tenant_app_id)
- idx_tenant_transaction_from ON tenant_transaction_app(from_member_user_id)
- idx_tenant_transaction_to ON tenant_transaction_app(to_member_user_id)

---

### 3.2 Authentication & Session Tables

#### Table: user_sessions
**Purpose**: Manages active user sessions

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| id | UUID | PRIMARY KEY DEFAULT uuid_generate_v4() | |
| member_user_id | UUID | NOT NULL REFERENCES member_user(id) ON DELETE CASCADE | |
| session_token | VARCHAR(255) | NOT NULL UNIQUE | Unique session identifier |
| ip_address | INET | NULL | Client IP address |
| user_agent | TEXT | NULL | Browser/client info |
| expires_at | TIMESTAMPTZ | NOT NULL | Session expiration |
| last_activity | TIMESTAMPTZ | NOT NULL DEFAULT NOW() | Last activity timestamp |
| is_active | BOOLEAN | NOT NULL DEFAULT TRUE | |
| created_at | TIMESTAMPTZ | NOT NULL DEFAULT NOW() | |

**Indexes**:
- idx_user_sessions_user ON user_sessions(member_user_id) WHERE is_active = TRUE
- idx_user_sessions_token ON user_sessions(session_token) WHERE is_active = TRUE
- idx_user_sessions_expires ON user_sessions(expires_at) WHERE is_active = TRUE

---

#### Table: refresh_tokens
**Purpose**: JWT refresh token management

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| id | UUID | PRIMARY KEY DEFAULT uuid_generate_v4() | |
| member_user_id | UUID | NOT NULL REFERENCES member_user(id) ON DELETE CASCADE | |
| token_hash | VARCHAR(255) | NOT NULL UNIQUE | SHA256 hash of refresh token |
| expires_at | TIMESTAMPTZ | NOT NULL | Token expiration (7-30 days) |
| revoked_at | TIMESTAMPTZ | NULL | When token was revoked |
| replaced_by | UUID | NULL REFERENCES refresh_tokens(id) | Token rotation tracking |
| created_at | TIMESTAMPTZ | NOT NULL DEFAULT NOW() | |
| created_by_ip | INET | NULL | IP that created token |

**Indexes**:
- idx_refresh_tokens_user ON refresh_tokens(member_user_id) WHERE revoked_at IS NULL
- idx_refresh_tokens_hash ON refresh_tokens(token_hash) WHERE revoked_at IS NULL
- idx_refresh_tokens_expires ON refresh_tokens(expires_at) WHERE revoked_at IS NULL

---

#### Table: access_tokens
**Purpose**: JWT access token tracking (optional, for revocation)

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| id | UUID | PRIMARY KEY DEFAULT uuid_generate_v4() | |
| jti | VARCHAR(255) | NOT NULL UNIQUE | JWT ID (unique identifier) |
| member_user_id | UUID | NOT NULL REFERENCES member_user(id) ON DELETE CASCADE | |
| token_type | VARCHAR(20) | NOT NULL DEFAULT 'Bearer' | |
| expires_at | TIMESTAMPTZ | NOT NULL | Token expiration (15-60 min) |
| revoked_at | TIMESTAMPTZ | NULL | When token was revoked |
| scopes | TEXT[] | NULL | Token scopes/permissions |
| created_at | TIMESTAMPTZ | NOT NULL DEFAULT NOW() | |

**Indexes**:
- idx_access_tokens_jti ON access_tokens(jti) WHERE revoked_at IS NULL
- idx_access_tokens_user ON access_tokens(member_user_id) WHERE revoked_at IS NULL
- idx_access_tokens_expires ON access_tokens(expires_at)

---

#### Table: oauth_providers
**Purpose**: External OAuth provider accounts linked to users

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| id | UUID | PRIMARY KEY DEFAULT uuid_generate_v4() | |
| member_user_id | UUID | NOT NULL REFERENCES member_user(id) ON DELETE CASCADE | |
| provider | VARCHAR(50) | NOT NULL | Values: google, facebook, microsoft, github |
| provider_user_id | VARCHAR(255) | NOT NULL | User ID from provider |
| provider_email | VARCHAR(255) | NULL | Email from provider |
| provider_name | VARCHAR(255) | NULL | Name from provider |
| provider_avatar | TEXT | NULL | Avatar URL from provider |
| access_token | TEXT | NULL | Encrypted provider access token |
| refresh_token | TEXT | NULL | Encrypted provider refresh token |
| token_expires_at | TIMESTAMPTZ | NULL | Provider token expiration |
| last_login | TIMESTAMPTZ | NULL | Last login via this provider |
| created_at | TIMESTAMPTZ | NOT NULL DEFAULT NOW() | |
| modified_at | TIMESTAMPTZ | NULL | |

**Constraints**:
- UNIQUE(provider, provider_user_id)
- UNIQUE(member_user_id, provider)

**Indexes**:
- idx_oauth_providers_user ON oauth_providers(member_user_id)
- idx_oauth_providers_provider_id ON oauth_providers(provider, provider_user_id)

---

#### Table: oauth_authorization_codes
**Purpose**: Temporary OAuth authorization codes (for OAuth flow)

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| id | UUID | PRIMARY KEY DEFAULT uuid_generate_v4() | |
| code | VARCHAR(255) | NOT NULL UNIQUE | Authorization code |
| member_user_id | UUID | NOT NULL REFERENCES member_user(id) | |
| client_app_id | UUID | NOT NULL REFERENCES client_app(id) | |
| redirect_uri | TEXT | NOT NULL | Callback URI |
| scopes | TEXT[] | NULL | Requested scopes |
| code_challenge | VARCHAR(255) | NULL | PKCE code challenge |
| code_challenge_method | VARCHAR(10) | NULL | S256 or plain |
| expires_at | TIMESTAMPTZ | NOT NULL | Code expiration (5-10 min) |
| used_at | TIMESTAMPTZ | NULL | When code was exchanged |
| created_at | TIMESTAMPTZ | NOT NULL DEFAULT NOW() | |

**Indexes**:
- idx_oauth_auth_codes_code ON oauth_authorization_codes(code) WHERE used_at IS NULL
- idx_oauth_auth_codes_expires ON oauth_authorization_codes(expires_at)

---

#### Table: password_reset_tokens
**Purpose**: Password reset token management

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| id | UUID | PRIMARY KEY DEFAULT uuid_generate_v4() | |
| member_user_id | UUID | NOT NULL REFERENCES member_user(id) ON DELETE CASCADE | |
| token_hash | VARCHAR(255) | NOT NULL UNIQUE | SHA256 hash of reset token |
| expires_at | TIMESTAMPTZ | NOT NULL | Token expiration (1 hour) |
| used_at | TIMESTAMPTZ | NULL | When token was used |
| created_at | TIMESTAMPTZ | NOT NULL DEFAULT NOW() | |

**Indexes**:
- idx_password_reset_hash ON password_reset_tokens(token_hash) WHERE used_at IS NULL
- idx_password_reset_expires ON password_reset_tokens(expires_at)

---

#### Table: email_verification_tokens
**Purpose**: Email verification token management

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| id | UUID | PRIMARY KEY DEFAULT uuid_generate_v4() | |
| member_user_id | UUID | NOT NULL REFERENCES member_user(id) ON DELETE CASCADE | |
| token_hash | VARCHAR(255) | NOT NULL UNIQUE | SHA256 hash of verification token |
| email | VARCHAR(255) | NOT NULL | Email to verify |
| expires_at | TIMESTAMPTZ | NOT NULL | Token expiration (24 hours) |
| verified_at | TIMESTAMPTZ | NULL | When email was verified |
| created_at | TIMESTAMPTZ | NOT NULL DEFAULT NOW() | |

**Indexes**:
- idx_email_verification_hash ON email_verification_tokens(token_hash) WHERE verified_at IS NULL
- idx_email_verification_expires ON email_verification_tokens(expires_at)

---

### 3.3 Audit & Security Tables

#### Table: audit_logs
**Purpose**: Comprehensive audit trail

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| id | UUID | PRIMARY KEY DEFAULT uuid_generate_v4() | |
| member_user_id | UUID | NULL REFERENCES member_user(id) | User who performed action |
| action | VARCHAR(100) | NOT NULL | Action type (login, create, update, delete) |
| entity_type | VARCHAR(100) | NOT NULL | Table/entity affected |
| entity_id | UUID | NULL | ID of affected record |
| old_values | JSONB | NULL | Previous values |
| new_values | JSONB | NULL | New values |
| ip_address | INET | NULL | Client IP |
| user_agent | TEXT | NULL | Browser/client |
| created_at | TIMESTAMPTZ | NOT NULL DEFAULT NOW() | |

**Indexes**:
- idx_audit_logs_user ON audit_logs(member_user_id)
- idx_audit_logs_entity ON audit_logs(entity_type, entity_id)
- idx_audit_logs_created ON audit_logs(created_at)

---

#### Table: login_attempts
**Purpose**: Track login attempts for rate limiting and security

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| id | UUID | PRIMARY KEY DEFAULT uuid_generate_v4() | |
| email | VARCHAR(255) | NOT NULL | Login email attempt |
| ip_address | INET | NOT NULL | Client IP |
| user_agent | TEXT | NULL | Browser/client |
| success | BOOLEAN | NOT NULL | Login success/failure |
| failure_reason | VARCHAR(100) | NULL | Reason if failed |
| created_at | TIMESTAMPTZ | NOT NULL DEFAULT NOW() | |

**Indexes**:
- idx_login_attempts_email ON login_attempts(email, created_at)
- idx_login_attempts_ip ON login_attempts(ip_address, created_at)
- idx_login_attempts_created ON login_attempts(created_at)

---

## 4. DATABASE CONSTRAINTS SUMMARY

### 4.1 Uniqueness Constraints
- member_user: email, display_name (per active records)
- client_app: unique_name (per active records)
- tenant_app: name, slug (per active records)
- group_app: (client_app_id, name) composite unique
- menu_app: (client_app_id, menu_name) composite unique
- OAuth providers: (provider, provider_user_id), (member_user_id, provider)

### 4.2 Foreign Key Cascades
- ON DELETE CASCADE: user_sessions, refresh_tokens, access_tokens, oauth_providers
- ON DELETE SET NULL: audit_logs (member_user_id)
- ON DELETE RESTRICT: Most other foreign keys to prevent accidental data loss

### 4.3 Check Constraints
- member_user_tenant_app: level_owner must be > 0 if is_owner = TRUE
- status_member: Must be one of predefined values
- type_app: Must be one of predefined values

---

## 5. INDEXES STRATEGY

### 5.1 Primary Indexes (Automatic)
- All PRIMARY KEY constraints automatically create unique indexes

### 5.2 Foreign Key Indexes
- All foreign key columns have indexes for join performance

### 5.3 Query Performance Indexes
- Composite indexes on frequently queried combinations
- Partial indexes with WHERE clauses for active/non-deleted records
- Index on session expiration for cleanup jobs

### 5.4 Full-Text Search (Future)
- Can add GIN indexes on text fields for full-text search if needed

---

## NEXT: SQL Scripts Generation

The complete PostgreSQL migration scripts will be generated in separate files:
1. `001_initial_schema.sql` - Core tables creation
2. `002_authentication_tables.sql` - Auth & session tables
3. `003_audit_security_tables.sql` - Audit & security tables
4. `004_indexes_constraints.sql` - Additional indexes
5. `005_seed_data.sql` - Dummy data for testing

---

## REFERENCES

- **PostgreSQL UUID Extension**: https://www.postgresql.org/docs/current/uuid-ossp.html
- **PostgreSQL Array Types**: https://www.postgresql.org/docs/current/arrays.html
- **PostgreSQL JSONB**: https://www.postgresql.org/docs/current/datatype-json.html
- **Database Security Best Practices**: https://wiki.postgresql.org/wiki/Security_Best_Practices
- **PostgreSQL Performance Tuning**: https://wiki.postgresql.org/wiki/Performance_Optimization  