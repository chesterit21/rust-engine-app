# SSO Fullstack Rust - Phase 2: Database Implementation

## üìã Overview

Phase 2 implementasi lengkap database schema, migration scripts, dan seed data untuk sistem SSO (Single Sign-On) menggunakan PostgreSQL.

## üóÑÔ∏è Database Schema

### Core Tables (9 tables)
1. **member_user** - User accounts (internal & OAuth)
2. **client_app** - Registered client applications
3. **menu_app** - Application menus (RBAC)
4. **group_app** - User groups/roles
5. **group_menu_app** - Permission matrix
6. **user_group_app** - User-group assignments
7. **tenant_app** - Multi-tenant organizations
8. **member_user_tenant_app** - User-tenant relationships
9. **tenant_transaction_app** - Tenant ownership transfers

### Authentication & Session Tables (9 tables)
1. **user_sessions** - Active session management
2. **refresh_tokens** - JWT refresh tokens
3. **access_tokens** - JWT access tokens (optional)
4. **oauth_providers** - External OAuth accounts
5. **oauth_authorization_codes** - OAuth flow codes
6. **password_reset_tokens** - Password reset
7. **email_verification_tokens** - Email verification
8. **two_factor_auth** - 2FA/MFA configuration
9. **oauth_states** - OAuth state tracking

### Audit & Security Tables (8 tables)
1. **audit_logs** - Comprehensive audit trail
2. **login_attempts** - Security monitoring
3. **security_events** - Suspicious activity
4. **ip_blacklist** - IP blocking
5. **rate_limits** - API rate limiting
6. **api_keys** - M2M authentication
7. **webhooks** - Webhook configuration
8. **webhook_deliveries** - Webhook delivery log

**Total: 26 production-grade tables**

## üìÅ Files Structure

```
phase2/
‚îú‚îÄ‚îÄ sso_database_schema_phase2.md      # Complete schema documentation
‚îú‚îÄ‚îÄ 001_initial_schema.sql             # Core tables migration
‚îú‚îÄ‚îÄ 002_authentication_tables.sql      # Auth & session tables
‚îú‚îÄ‚îÄ 003_audit_security_tables.sql      # Audit & security tables
‚îú‚îÄ‚îÄ 004_seed_data.sql                  # Dummy data for testing
‚îú‚îÄ‚îÄ migrate.sh                         # Migration helper script
‚îú‚îÄ‚îÄ docker-compose.yml                 # Development environment
‚îî‚îÄ‚îÄ .env.example                       # Environment configuration
```

## üöÄ Quick Start

### 1. Using Docker Compose (Recommended)

```bash
# Start PostgreSQL and Redis
docker-compose up -d postgres redis

# Wait for services to be healthy (10-15 seconds)
docker-compose ps

# Run migrations
./migrate.sh fresh

# Or manually:
docker-compose exec postgres psql -U postgres -d sso_rust_db -f /docker-entrypoint-initdb.d/001_initial_schema.sql
```

### 2. Manual Setup

```bash
# 1. Create database
createdb sso_rust_db

# 2. Run migrations in order
psql -d sso_rust_db -f 001_initial_schema.sql
psql -d sso_rust_db -f 002_authentication_tables.sql
psql -d sso_rust_db -f 003_audit_security_tables.sql

# 3. Seed dummy data
psql -d sso_rust_db -f 004_seed_data.sql
```

### 3. Using Migration Script

```bash
# Make script executable
chmod +x migrate.sh

# Run all migrations
./migrate.sh up

# Run migrations + seed data
./migrate.sh fresh

# Seed data only
./migrate.sh seed

# Show database info
./migrate.sh info

# Rollback (WARNING: Deletes all data)
./migrate.sh rollback
```

## üîê Default Credentials

### Users (Password: `Password123!`)

| Email | Role | Display Name |
|-------|------|-------------|
| admin@sso-system.com | System Admin | System Administrator |
| john.doe@acme-corp.com | Super Admin (Tenant) | John Doe |
| jane.smith@acme-corp.com | Administrator | Jane Smith |
| alice.johnson@acme-corp.com | Manager | Alice Johnson |
| bob.williams@acme-corp.com | User | Bob Williams |
| david.brown@gmail.com | OAuth User (Google) | David Brown |

### Database Access
- **Database**: `sso_rust_db`
- **User**: `postgres`
- **Password**: `postgres`
- **Host**: `localhost`
- **Port**: `5432`

### Redis Access
- **Host**: `localhost`
- **Port**: `6379`
- **Password**: `redispassword`

### Management UIs
- **PgAdmin**: http://localhost:5050 (admin@sso-system.com / admin123)
- **Redis Commander**: http://localhost:8081

## üìä Dummy Data Summary

### Tenants
- **ACME Corporation** (slug: acme-corp)
  - Subscription: Enterprise
  - Max Users: 50
  - Primary Owner: John Doe
  - Secondary Owner: Jane Smith

- **Tech Startup Inc** (slug: tech-startup)
  - Subscription: Premium
  - Max Users: 20
  - Owner: Jane Smith

### Client Applications
1. **ACME Dashboard** (web) - Main dashboard
2. **ACME Mobile App** (mobile) - Mobile application
3. **ACME API Gateway** (api) - RESTful API

### Menus (ACME Dashboard)
- **Dashboard** (Root)
- **Users** (Root)
  - User List
  - Add User
  - Roles & Permissions
- **Settings** (Root)
  - General Settings
  - Security
  - Integrations
- **Reports** (Root)

### Groups & Permissions
1. **Super Admin** - Full access (all CRUD operations)
2. **Administrator** - Most permissions (no delete on critical)
3. **Manager** - Limited permissions
4. **User** - Standard access
5. **Read Only** - View & download only

### User Assignments
- John Doe ‚Üí Super Admin (ACME Corp)
- Jane Smith ‚Üí Administrator (ACME Corp + Tech Startup owner)
- Alice Johnson ‚Üí Manager (ACME Corp)
- Bob Williams ‚Üí User (ACME Corp)

## üîç Useful Queries

### Get User Permissions
```sql
-- Get all menus accessible by a user
SELECT DISTINCT
    m.menu_name,
    m.menu_url,
    gm.is_view,
    gm.is_add,
    gm.is_edit,
    gm.is_delete
FROM member_user u
JOIN user_group_app ug ON u.id = ug.member_user_id
JOIN group_menu_app gm ON ug.group_app_id = gm.group_app_id
JOIN menu_app m ON gm.menu_app_id = m.id
WHERE u.email = 'john.doe@acme-corp.com'
    AND ug.is_active = TRUE
    AND ug.removed_at IS NULL
ORDER BY m.menu_level, m.menu_order;
```

### Get User's Tenants
```sql
SELECT 
    u.display_name,
    t.name as tenant_name,
    mut.role_in_tenant,
    mut.is_owner,
    mut.level_owner
FROM member_user u
JOIN member_user_tenant_app mut ON u.id = mut.member_user_id
JOIN tenant_app t ON mut.tenant_app_id = t.id
WHERE u.email = 'john.doe@acme-corp.com'
    AND mut.removed_at IS NULL;
```

### Get Active Sessions
```sql
SELECT 
    u.email,
    u.display_name,
    s.ip_address,
    s.last_activity,
    s.expires_at
FROM user_sessions s
JOIN member_user u ON s.member_user_id = u.id
WHERE s.is_active = TRUE
    AND s.expires_at > NOW()
ORDER BY s.last_activity DESC;
```

### Audit Trail for User
```sql
SELECT 
    action,
    entity_type,
    created_at,
    ip_address,
    new_values
FROM audit_logs
WHERE member_user_id = (
    SELECT id FROM member_user WHERE email = 'john.doe@acme-corp.com'
)
ORDER BY created_at DESC
LIMIT 50;
```

## üèóÔ∏è Database Features

### ‚úÖ Implemented Features

1. **UUID Primary Keys** - All tables use UUID v4
2. **Soft Delete** - Using `removed_at` timestamp
3. **Audit Trail** - Complete audit fields on all tables
4. **Indexes** - Strategic indexes for performance
5. **Foreign Key Constraints** - Data integrity enforcement
6. **Check Constraints** - Data validation at DB level
7. **Unique Constraints** - Prevent duplicates
8. **Partial Indexes** - Optimized for active records
9. **JSONB Support** - Flexible metadata storage
10. **Array Types** - For scopes, redirect URIs, etc.
11. **INET Type** - Proper IP address storage
12. **Timestamp with Timezone** - Proper datetime handling

### üîí Security Features

1. **Password Hashing** - Bcrypt with cost factor 12
2. **Token Hashing** - SHA256 for tokens
3. **OAuth 2.0 Support** - Multiple providers
4. **PKCE Support** - Enhanced OAuth security
5. **Session Management** - Redis-backed sessions
6. **Rate Limiting** - API protection
7. **IP Blacklisting** - Block malicious IPs
8. **2FA Support** - Two-factor authentication
9. **Audit Logging** - Complete action tracking
10. **Security Events** - Suspicious activity detection

### üìà Performance Optimizations

1. **Connection Pooling** - Efficient DB connections
2. **Index Strategy** - Optimized queries
3. **Partial Indexes** - Reduced index size
4. **Cache Layer** - Redis for hot data
5. **JSONB Indexes** - Fast JSON queries
6. **Array GIN Indexes** - Efficient array searches

## üß™ Testing

### Verify Installation
```bash
# Check table count
psql -d sso_rust_db -c "SELECT COUNT(*) FROM information_schema.tables WHERE table_schema = 'public';"

# Check data
psql -d sso_rust_db -c "SELECT COUNT(*) FROM member_user;"
psql -d sso_rust_db -c "SELECT COUNT(*) FROM client_app;"
psql -d sso_rust_db -c "SELECT COUNT(*) FROM menu_app;"
```

### Test Login Flow
```sql
-- Simulate login attempt
INSERT INTO login_attempts (email, ip_address, success, created_at)
VALUES ('john.doe@acme-corp.com', '192.168.1.100', true, NOW());

-- Create session
INSERT INTO user_sessions (
    member_user_id, 
    session_token, 
    ip_address, 
    expires_at
) VALUES (
    (SELECT id FROM member_user WHERE email = 'john.doe@acme-corp.com'),
    encode(gen_random_bytes(32), 'hex'),
    '192.168.1.100'::inet,
    NOW() + INTERVAL '24 hours'
);
```

## üîß Maintenance

### Cleanup Expired Data
```sql
-- Delete expired sessions
DELETE FROM user_sessions 
WHERE expires_at < NOW() OR last_activity < NOW() - INTERVAL '30 days';

-- Delete expired tokens
DELETE FROM refresh_tokens WHERE expires_at < NOW();
DELETE FROM access_tokens WHERE expires_at < NOW();

-- Delete old audit logs (keep 90 days)
DELETE FROM audit_logs WHERE created_at < NOW() - INTERVAL '90 days';
```

### Database Backup
```bash
# Backup
pg_dump sso_rust_db > backup_$(date +%Y%m%d).sql

# Backup with compression
pg_dump sso_rust_db | gzip > backup_$(date +%Y%m%d).sql.gz

# Restore
psql sso_rust_db < backup_20240120.sql
```

## üìö References

- [PostgreSQL Documentation](https://www.postgresql.org/docs/)
- [PostgreSQL Best Practices](https://wiki.postgresql.org/wiki/Don%27t_Do_This)
- [OAuth 2.0 RFC 6749](https://datatracker.ietf.org/doc/html/rfc6749)
- [JWT Best Practices](https://datatracker.ietf.org/doc/html/rfc8725)
- [OWASP Authentication](https://cheatsheetseries.owasp.org/cheatsheets/Authentication_Cheat_Sheet.html)

## ‚ö†Ô∏è Important Notes

### Development vs Production

**DO NOT use these settings in production:**
- Default passwords
- Weak secrets
- HTTP (use HTTPS)
- Debug logging
- Permissive CORS

**Production Requirements:**
- Strong random secrets (use `openssl rand -base64 64`)
- SSL/TLS certificates
- Proper firewall rules
- Database encryption at rest
- Regular backups
- Monitoring and alerting
- Rate limiting
- IP whitelisting

## üéØ Next Steps (Phase 3)

Phase 3 akan fokus pada implementasi Backend Code:

1. ‚úÖ Rust entities sesuai database schema
2. ‚úÖ Repository implementations (SQLx)
3. ‚úÖ Service layer dengan business logic
4. ‚úÖ API handlers (Axum)
5. ‚úÖ Authentication & Authorization
6. ‚úÖ OAuth 2.0 integration
7. ‚úÖ JWT token management
8. ‚úÖ Input validation
9. ‚úÖ Error handling
10. ‚úÖ Testing (unit + integration)

---

**Phase 2 Status: ‚úÖ COMPLETE**

Total Tables: 26  
Total SQL Lines: ~2000  
Migration Scripts: 4  
Dummy Users: 7  
Dummy Data: Comprehensive  

**Ready for Phase 3: Backend Implementation**